
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <!-- common.css -->
      <style>* {-webkit-tap-highlight-color: rgba(0,0,0,0);}html {-webkit-text-size-adjust: none;}body {font-family: -apple-system, Helvetica, Arial, sans-serif;margin: 0;padding: 20px;color: #333;word-wrap: break-word;}h1, h2, h3, h4, h5, h6 {line-height: 1.1;}img {max-width: 100% !important;height: auto;}blockquote {margin: 0;padding: 0 15px;color: #777;border-left: 4px solid #ddd;}hr {background-color: #ddd;border: 0;height: 1px;margin: 15px 0;}code {font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, 'source-code-pro', monospace;line-height: 1.4;margin: 0;padding: 0.2em 0;font-size: 90%;background-color: rgba(0,0,0,0.04);border-radius: 3px;}pre > code {margin: 0;padding: 0;font-size: 100%;word-break: normal;background: transparent;border: 0;}ol {list-style-type: decimal;}ol ol, ul ol {list-style-type: lower-latin;}ol ol ol, ul ol ol, ul ul ol, ol ul ol {list-style-type: lower-roman;}table {border-spacing: 0;border-collapse: collapse;margin-top: 0;margin-bottom: 16px;}table th {font-weight: bold;}table th, table td {padding: 6px 13px;border: 1px solid #ddd;}table tr {border-top: 1px solid #ccc;}table tr:nth-child(even) {background-color: #f8f8f8;}input[type="checkbox"] {cursor: default;margin-right: 0.5em;font-size: 13px;}.task-list-item {list-style-type: none;}.task-list-item+.task-list-item {margin-top: 3px;}.task-list-item input {float: left;margin: 0.3em 1em 0.25em -1.6em;vertical-align: middle;}#tag-field {margin: 8px 2px 10px;}#tag-field .tag {display: inline-block;background: #cadff3;border-radius: 4px;padding: 1px 8px;color: black;font-size: 12px;margin-right: 10px;line-height: 1.4;}</style>
      <!-- ace-static.css -->
      <style>.ace_static_highlight {white-space: pre-wrap;}.ace_static_highlight .ace_gutter {width: 2em;text-align: right;padding: 0 3px 0 0;margin-right: 3px;}.ace_static_highlight.ace_show_gutter > .ace_line {padding-left: 2.6em;}.ace_static_highlight .ace_line {position: relative;}.ace_static_highlight .ace_gutter-cell {-moz-user-select: -moz-none;-khtml-user-select: none;-webkit-user-select: none;user-select: none;top: 0;bottom: 0;left: 0;position: absolute;}.ace_static_highlight .ace_gutter-cell:before {content: counter(ace_line, decimal);counter-increment: ace_line;}.ace_static_highlight {counter-reset: ace_line;}</style>
      <style>.ace-chrome .ace_gutter {background: #ebebeb;color: #333;overflow : hidden;}.ace-chrome .ace_print-margin {width: 1px;background: #e8e8e8;}.ace-chrome {background-color: #FFFFFF;color: black;}.ace-chrome .ace_cursor {color: black;}.ace-chrome .ace_invisible {color: rgb(191, 191, 191);}.ace-chrome .ace_constant.ace_buildin {color: rgb(88, 72, 246);}.ace-chrome .ace_constant.ace_language {color: rgb(88, 92, 246);}.ace-chrome .ace_constant.ace_library {color: rgb(6, 150, 14);}.ace-chrome .ace_invalid {background-color: rgb(153, 0, 0);color: white;}.ace-chrome .ace_fold {}.ace-chrome .ace_support.ace_function {color: rgb(60, 76, 114);}.ace-chrome .ace_support.ace_constant {color: rgb(6, 150, 14);}.ace-chrome .ace_support.ace_type,.ace-chrome .ace_support.ace_class.ace-chrome .ace_support.ace_other {color: rgb(109, 121, 222);}.ace-chrome .ace_variable.ace_parameter {font-style:italic;color:#FD971F;}.ace-chrome .ace_keyword.ace_operator {color: rgb(104, 118, 135);}.ace-chrome .ace_comment {color: #236e24;}.ace-chrome .ace_comment.ace_doc {color: #236e24;}.ace-chrome .ace_comment.ace_doc.ace_tag {color: #236e24;}.ace-chrome .ace_constant.ace_numeric {color: rgb(0, 0, 205);}.ace-chrome .ace_variable {color: rgb(49, 132, 149);}.ace-chrome .ace_xml-pe {color: rgb(104, 104, 91);}.ace-chrome .ace_entity.ace_name.ace_function {color: #0000A2;}.ace-chrome .ace_heading {color: rgb(12, 7, 255);}.ace-chrome .ace_list {color:rgb(185, 6, 144);}.ace-chrome .ace_marker-layer .ace_selection {background: rgb(181, 213, 255);}.ace-chrome .ace_marker-layer .ace_step {background: rgb(252, 255, 0);}.ace-chrome .ace_marker-layer .ace_stack {background: rgb(164, 229, 101);}.ace-chrome .ace_marker-layer .ace_bracket {margin: -1px 0 0 -1px;border: 1px solid rgb(192, 192, 192);}.ace-chrome .ace_marker-layer .ace_active-line {background: rgba(0, 0, 0, 0.07);}.ace-chrome .ace_gutter-active-line {background-color : #dcdcdc;}.ace-chrome .ace_marker-layer .ace_selected-word {background: rgb(250, 250, 255);border: 1px solid rgb(200, 200, 250);}.ace-chrome .ace_storage,.ace-chrome .ace_keyword,.ace-chrome .ace_meta.ace_tag {color: rgb(147, 15, 128);}.ace-chrome .ace_string.ace_regex {color: rgb(255, 0, 0)}.ace-chrome .ace_string {color: #1A1AA6;}.ace-chrome .ace_entity.ace_other.ace_attribute-name {color: #994409;}.ace-chrome .ace_indent-guide {background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAE0lEQVQImWP4////f4bLly//BwAmVgd1/w11/gAAAABJRU5ErkJggg==") right repeat-y;}</style>
      <!-- export.css -->
      <style>
        body{margin:0 auto;max-width:800px;line-height:1.4}
        #nav{margin:5px 0 10px;font-size:15px}
        #titlearea{border-bottom:1px solid #ccc;font-size:17px;padding:10px 0;}
        #contentarea{font-size:15px;margin:16px 0}
        .cell{outline:0;min-height:20px;margin:5px 0;padding:5px 0;}
        .code-cell{font-family:Menlo,Consolas,'Ubuntu Mono',Monaco,'source-code-pro',monospace;font-size:12px;}
        .latex-cell{white-space:pre-wrap;}
      </style>
      <!-- User CSS -->
      <style> .text-cell {font-size: 15px;}.code-cell {font-size: 12px;}.markdown-cell {font-size: 15px;}.latex-cell {font-size: 15px;}</style>
    </head>
    <body>
      
      <div id="titlearea">
        <h2>PHP GC算法解析与源码分析(以PHP7为例)</h2>
      </div>
      <div id="contentarea"><div class="cell text-cell"><p><a href="http://researcher.watson.ibm.com/researcher/files/us-bacon/Bacon01Concurrent.pdf">http://researcher.watson.ibm.com/researcher/files/us-bacon/Bacon01Concurrent.pdf</a><b><br></b></p><p><b>论文摘要&amp;笔记</b></p>
<p><strong>引用计数的3个主要问题:</strong></p>
<ol>
<li><strong>存储开销</strong>: 每个对象都要保持一个计数器</li>
<li><strong>运行时开销</strong>: 当指针每次被 copy 时需要加减引用计数</li>
<li><strong>无法检测循环引用</strong>: 从而必须额外引入一种垃圾回收技术处理循环引用的垃圾</li>
</ol>
<p><strong>循环引用垃圾搜集算法的两个基础事实:</strong></p>
<ol>
<li>循环引用只有引用计数被减到非零值才会被创建, 当引用计数增加, 不会产生垃圾, 当引用计数减至零, 垃圾当即产生; 并且, 大部分对象的引用计数通常都是1, 直接可减至零;</li>
<li>在循环引用场景中, 所有的引用计数值都来自循环引用内部, 因此, 当内部的引用计数减少时, 循环引用便会被发现;</li>
</ol>
<p><strong>传统循环引用处理方法:</strong></p>
<p>当某对象的引用计数减至大于零的值, 则该对象成为一个可能存在循环引用的根对象, 对该根对象执行一次深度优先搜索, 减少所有子对象的引用计数, 当最后得到一个引用计数全部为零的对象的集合, 则表示存在循环引用, 进行回收, 如果不是, 则再执行一次深度优先搜索, 恢复所有对象的引用计数;</p>
<p>这个算法被扩展为: 对可能的循环引用根对象进行缓存, 惰性搜索, 而不是立即搜索. 这样有两个好处:</p>
<ol>
<li>一段时间之后, 由于某条边被删除, 可能存在循环引用根对象的引用计数值降为零, 可以直接进行收集; 或者由于某条边添加, 引用计数重新增长使得该对象暂时不是一个循环引用根对象;</li>
<li>可以避免节点的重复迭代;</li>
</ol>
<p>要对所有循环引用根对象扫描, 下图导致该算法复杂度为 O(n2);</p>
<p><img src="resources/20B08E73C536A321D2C4C214E91D6939.jpg" alt=""></p>
<p><strong>分色算法</strong></p>
<p><i>相较于并行, 这里指同步版本</i><br></p><p>复杂度O(N+E), N为节点数, E 为对象图边数;</p>
<p>当引用计数减少时, 当可能存在循环引用的根对象加入缓存(Roots), 并且周期性扫描缓存(Roots), 通过减少内部引用计数寻找循环引用;</p>
<p>该算法拥有线性时间复杂度, 主要得益于两个修改: 首先, 每个对象都加入一个 bufferd 标记, 在每次垃圾回收时, 用来避免相同对象被多次加入缓存(Roots), 限制了缓存(Roots) 的大小只能线性增长;</p>
<p>第二, 我们将缓存(Roots)作为一整个transitive closure来分析, 而不是作为一个对象图(graph)的集合来看待; 这意味着算法复杂度被 transitive closure 大小限制, 而 transitive closure 大小由于缓存(Roots)大小受到 buffered 标记约束的原因被限制在了N+E; 当然, 我们希望实际上transitive closure越小越好. 事实上我们发现第一种修改(使用 buffered 标记)对算法运行时间基本无影响; 但是第二种修改(一次性分析整个 对象图 )对运行时间产生巨大影响. 当我们将Lins的算法应用到大型程序时, 垃圾延迟延长到几分钟;</p>
<p>除了 buffered 标记, 每个对象还含有 color 与 reference count 字段. 对于对象 T, 这些字段表示为 <strong>buffered(T), color(T),&nbsp;</strong>与<strong> RC(T)</strong>; 当前实现中, 三个字段共同占有每个对象的1个 word 大小; 所有对象初始化为 Black.</p>
<table>
<thead>
<tr>
<th>颜色</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>Black</td>
<td>使用中或已释放</td>
</tr>
<tr>
<td>Gray</td>
<td>潜在的循环引用成员</td>
</tr>
<tr>
<td>White</td>
<td>待回收垃圾</td>
</tr>
<tr>
<td>Purple</td>
<td>潜在的循环引用根对象</td></tr></tbody></table></div><div class="cell code-cell"><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">伪</span><span class="ace_cjk" style="width:NaNpx">代</span><span class="ace_cjk" style="width:NaNpx">码</span> &amp; <span class="ace_cjk" style="width:NaNpx">说</span><span class="ace_cjk" style="width:NaNpx">明</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">针</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">添</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">删</span><span class="ace_cjk" style="width:NaNpx">除</span><span class="ace_cjk" style="width:NaNpx">或</span><span class="ace_cjk" style="width:NaNpx">覆</span><span class="ace_cjk" style="width:NaNpx">盖</span><span class="ace_cjk" style="width:NaNpx">时</span>, Increment <span class="ace_cjk" style="width:NaNpx">与</span> Decrement <span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span>;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">当</span> 1.<span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">缓</span><span class="ace_cjk" style="width:NaNpx">存</span>(Roots buffer)<span class="ace_cjk" style="width:NaNpx">满</span><span class="ace_cjk" style="width:NaNpx">了</span> </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># 2.<span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">储</span><span class="ace_cjk" style="width:NaNpx">耗</span><span class="ace_cjk" style="width:NaNpx">尽</span> (PHP <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">是</span> memory_limit <span class="ace_cjk" style="width:NaNpx">达</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">上</span><span class="ace_cjk" style="width:NaNpx">限</span>)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># 3.<span class="ace_cjk" style="width:NaNpx">使</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">者</span><span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">某</span><span class="ace_cjk" style="width:NaNpx">些</span><span class="ace_cjk" style="width:NaNpx">原</span><span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">决</span><span class="ace_cjk" style="width:NaNpx">定</span><span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span><span class="ace_cjk" style="width:NaNpx">循</span><span class="ace_cjk" style="width:NaNpx">环</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span> <span class="ace_cjk" style="width:NaNpx">时</span>, CollectCycles <span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span>. (PHP <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span> gc_collect_cycles()))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">其</span><span class="ace_cjk" style="width:NaNpx">余</span><span class="ace_cjk" style="width:NaNpx">都</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">收</span><span class="ace_cjk" style="width:NaNpx">集</span><span class="ace_cjk" style="width:NaNpx">器</span><span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">部</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span>.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># Roots buffer <span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">缓</span><span class="ace_cjk" style="width:NaNpx">冲</span><span class="ace_cjk" style="width:NaNpx">区</span> (<span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">循</span><span class="ace_cjk" style="width:NaNpx">环</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span><span class="ace_cjk" style="width:NaNpx">的</span> buffer <span class="ace_cjk" style="width:NaNpx">列</span><span class="ace_cjk" style="width:NaNpx">表</span>)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># Increment(S) <span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">任</span><span class="ace_cjk" style="width:NaNpx">何</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">增</span><span class="ace_cjk" style="width:NaNpx">长</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">都</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span>, <span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">创</span><span class="ace_cjk" style="width:NaNpx">建</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span> S <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">时</span>, <span class="ace_cjk" style="width:NaNpx">增</span><span class="ace_cjk" style="width:NaNpx">加</span> T <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">黑</span><span class="ace_cjk" style="width:NaNpx">色</span>. </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">Increment</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_identifier">RC</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">RC</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_constant ace_numeric">1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_identifier">color</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">black</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># Decrement(S) <span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span> S <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">删</span><span class="ace_cjk" style="width:NaNpx">除</span><span class="ace_cjk" style="width:NaNpx">时</span>, <span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">减</span>1. </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">减</span><span class="ace_cjk" style="width:NaNpx">为</span>0, <span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span> Release <span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span>. </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">尚</span><span class="ace_cjk" style="width:NaNpx">未</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">减</span><span class="ace_cjk" style="width:NaNpx">为</span>0, <span class="ace_cjk" style="width:NaNpx">则</span><span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span><span class="ace_cjk" style="width:NaNpx">成</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">循</span><span class="ace_cjk" style="width:NaNpx">环</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span>.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">Decrement</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_identifier">RC</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">RC</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">-</span> <span class="ace_constant ace_numeric">1</span> 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_keyword">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">RC</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">Release</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_keyword">else</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">PossibleRoot</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># Release(S) <span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">为</span>0<span class="ace_cjk" style="width:NaNpx">时</span>, <span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">部</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">针</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">删</span><span class="ace_cjk" style="width:NaNpx">除</span>, <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">黑</span><span class="ace_cjk" style="width:NaNpx">色</span>, </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">除</span><span class="ace_cjk" style="width:NaNpx">非</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span> buffered (<span class="ace_cjk" style="width:NaNpx">在</span> Roots Buffer <span class="ace_cjk" style="width:NaNpx">中</span>), <span class="ace_cjk" style="width:NaNpx">否</span><span class="ace_cjk" style="width:NaNpx">则</span><span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span><span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">存</span>. </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span> buffered , <span class="ace_cjk" style="width:NaNpx">将</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">之</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">的</span> MarkRoots <span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span>(free).</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># (<span class="ace_cjk" style="width:NaNpx">注</span><span class="ace_cjk" style="width:NaNpx">释</span>: <span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">父</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span>, <span class="ace_cjk" style="width:NaNpx">子</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span> Decrement <span class="ace_cjk" style="width:NaNpx">减</span>1<span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span>)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># (<span class="ace_cjk" style="width:NaNpx">注</span><span class="ace_cjk" style="width:NaNpx">释</span>: <span class="ace_cjk" style="width:NaNpx">黑</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">代</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span>(<span class="ace_cjk" style="width:NaNpx">非</span><span class="ace_cjk" style="width:NaNpx">已</span>free))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># (<span class="ace_cjk" style="width:NaNpx">注</span><span class="ace_cjk" style="width:NaNpx">释</span>: Decrement-&gt; Release, <span class="ace_cjk" style="width:NaNpx">在</span> buffer <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span> refouct <span class="ace_cjk" style="width:NaNpx">等</span><span class="ace_cjk" style="width:NaNpx">于</span>0, <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">处</span><span class="ace_cjk" style="width:NaNpx">理</span>, </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">还</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">从</span> buffer <span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span>, <span class="ace_cjk" style="width:NaNpx">处</span><span class="ace_cjk" style="width:NaNpx">理</span><span class="ace_cjk" style="width:NaNpx">子</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span>, <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">统</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">延</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">到</span> gc <span class="ace_cjk" style="width:NaNpx">阶</span><span class="ace_cjk" style="width:NaNpx">段</span>)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">Release</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_keyword">for</span> <span class="ace_identifier">T</span> <span class="ace_keyword">in</span> <span class="ace_identifier">children</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">Decrement</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">T</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_identifier">color</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">black</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_keyword">if</span> <span class="ace_paren ace_lparen">(</span>! <span class="ace_identifier">buffered</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">Free</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># PossibleRoot(S) <span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">减</span><span class="ace_cjk" style="width:NaNpx">但</span><span class="ace_cjk" style="width:NaNpx">尚</span><span class="ace_cjk" style="width:NaNpx">未</span><span class="ace_cjk" style="width:NaNpx">达</span><span class="ace_cjk" style="width:NaNpx">到</span>0<span class="ace_cjk" style="width:NaNpx">时</span>, <span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span> S <span class="ace_cjk" style="width:NaNpx">成</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">循</span><span class="ace_cjk" style="width:NaNpx">环</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span>. </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">经</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">紫</span><span class="ace_cjk" style="width:NaNpx">色</span>, <span class="ace_cjk" style="width:NaNpx">则</span><span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span><span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">经</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">候</span><span class="ace_cjk" style="width:NaNpx">选</span><span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span>, <span class="ace_cjk" style="width:NaNpx">否</span><span class="ace_cjk" style="width:NaNpx">则</span><span class="ace_cjk" style="width:NaNpx">则</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">紫</span><span class="ace_cjk" style="width:NaNpx">色</span>. </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">之</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">检</span><span class="ace_cjk" style="width:NaNpx">查</span> buffered <span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span>, <span class="ace_cjk" style="width:NaNpx">观</span><span class="ace_cjk" style="width:NaNpx">察</span><span class="ace_cjk" style="width:NaNpx">自</span><span class="ace_cjk" style="width:NaNpx">从</span><span class="ace_cjk" style="width:NaNpx">上</span><span class="ace_cjk" style="width:NaNpx">次</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span><span class="ace_cjk" style="width:NaNpx">回</span><span class="ace_cjk" style="width:NaNpx">收</span><span class="ace_cjk" style="width:NaNpx">之</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">否</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">经</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">紫</span><span class="ace_cjk" style="width:NaNpx">色</span>. </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">没</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span> buffered, <span class="ace_cjk" style="width:NaNpx">则</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span> buffered <span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span> Roots buffer.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">PossibleRoot</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_keyword">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">color</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">purple</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">color</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">purple</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword">if</span> <span class="ace_paren ace_lparen">(</span>! <span class="ace_identifier">buffered</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_identifier">buffered</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">true</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_identifier">append</span> <span class="ace_identifier">S</span> <span class="ace_identifier">to</span> <span class="ace_identifier">Roots</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">分</span><span class="ace_cjk" style="width:NaNpx">色</span>GC <span class="ace_cjk" style="width:NaNpx">三</span><span class="ace_cjk" style="width:NaNpx">部</span><span class="ace_cjk" style="width:NaNpx">曲</span>: mark &amp; scan &amp; collect</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># CollectCycles() <span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">缓</span><span class="ace_cjk" style="width:NaNpx">冲</span><span class="ace_cjk" style="width:NaNpx">区</span><span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">满</span>,<span class="ace_cjk" style="width:NaNpx">或</span><span class="ace_cjk" style="width:NaNpx">者</span><span class="ace_cjk" style="width:NaNpx">其</span><span class="ace_cjk" style="width:NaNpx">他</span><span class="ace_cjk" style="width:NaNpx">条</span><span class="ace_cjk" style="width:NaNpx">件</span>,<span class="ace_cjk" style="width:NaNpx">比</span><span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">足</span>, <span class="ace_cjk" style="width:NaNpx">将</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">触</span><span class="ace_cjk" style="width:NaNpx">发</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span><span class="ace_cjk" style="width:NaNpx">回</span><span class="ace_cjk" style="width:NaNpx">收</span>. </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">分</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">三</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">阶</span><span class="ace_cjk" style="width:NaNpx">段</span>, MarkRoots <span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span><span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">部</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span>; ScanRoots <span class="ace_cjk" style="width:NaNpx">恢</span><span class="ace_cjk" style="width:NaNpx">复</span><span class="ace_cjk" style="width:NaNpx">非</span><span class="ace_cjk" style="width:NaNpx">零</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span>; CollectRoots, <span class="ace_cjk" style="width:NaNpx">收</span><span class="ace_cjk" style="width:NaNpx">集</span><span class="ace_cjk" style="width:NaNpx">循</span><span class="ace_cjk" style="width:NaNpx">环</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span>.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">CollectCycles</span><span class="ace_paren ace_lparen">(</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_identifier">MarkRoots</span><span class="ace_paren ace_lparen">(</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_identifier">ScanRoots</span><span class="ace_paren ace_lparen">(</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_identifier">CollectRoots</span><span class="ace_paren ace_lparen">(</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># MarkRoots() <span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">阶</span><span class="ace_cjk" style="width:NaNpx">段</span><span class="ace_cjk" style="width:NaNpx">扫</span><span class="ace_cjk" style="width:NaNpx">描</span><span class="ace_cjk" style="width:NaNpx">自</span><span class="ace_cjk" style="width:NaNpx">上</span><span class="ace_cjk" style="width:NaNpx">次</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span><span class="ace_cjk" style="width:NaNpx">回</span><span class="ace_cjk" style="width:NaNpx">收</span><span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">来</span>, <span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">针</span><span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">储</span><span class="ace_cjk" style="width:NaNpx">在</span> Roots buffer <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span><span class="ace_cjk" style="width:NaNpx">列</span><span class="ace_cjk" style="width:NaNpx">表</span>. </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">是</span> purple (<span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">明</span><span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">循</span><span class="ace_cjk" style="width:NaNpx">环</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span>) <span class="ace_cjk" style="width:NaNpx">且</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">尚</span><span class="ace_cjk" style="width:NaNpx">未</span><span class="ace_cjk" style="width:NaNpx">达</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">为</span>0, </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">则</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span> MarkGray(S) <span class="ace_cjk" style="width:NaNpx">执</span><span class="ace_cjk" style="width:NaNpx">行</span><span class="ace_cjk" style="width:NaNpx">深</span><span class="ace_cjk" style="width:NaNpx">度</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span><span class="ace_cjk" style="width:NaNpx">搜</span><span class="ace_cjk" style="width:NaNpx">索</span>, <span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">灰</span><span class="ace_cjk" style="width:NaNpx">色</span>, <span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">部</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">减</span>1. </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># (<span class="ace_cjk" style="width:NaNpx">注</span><span class="ace_cjk" style="width:NaNpx">释</span>: <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">只</span><span class="ace_cjk" style="width:NaNpx">对</span> purple <span class="ace_cjk" style="width:NaNpx">判</span><span class="ace_cjk" style="width:NaNpx">断</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">为</span>, Decrement-&gt;PossibleRoot <span class="ace_cjk" style="width:NaNpx">且</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">大</span><span class="ace_cjk" style="width:NaNpx">于</span>0, <span class="ace_cjk" style="width:NaNpx">才</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">紫</span><span class="ace_cjk" style="width:NaNpx">色</span>, purple <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">的</span> refcount <span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">定</span><span class="ace_cjk" style="width:NaNpx">大</span><span class="ace_cjk" style="width:NaNpx">于</span>0)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">否</span><span class="ace_cjk" style="width:NaNpx">则</span>, <span class="ace_cjk" style="width:NaNpx">从</span> Roots buffer <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span><span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span><span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">除</span> buffered <span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span>, <span class="ace_cjk" style="width:NaNpx">此</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">为</span>0, <span class="ace_cjk" style="width:NaNpx">则</span><span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span>(free).</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># (<span class="ace_cjk" style="width:NaNpx">注</span><span class="ace_cjk" style="width:NaNpx">释</span>: Decrement-&gt;Release <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">黑</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">且</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">等</span><span class="ace_cjk" style="width:NaNpx">于</span>0, <span class="ace_cjk" style="width:NaNpx">有</span> buffered <span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">延</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span><span class="ace_cjk" style="width:NaNpx">放</span><span class="ace_cjk" style="width:NaNpx">生</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span>)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">MarkRoots</span><span class="ace_paren ace_lparen">(</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_keyword">for</span> <span class="ace_identifier">S</span> <span class="ace_keyword">in</span> <span class="ace_identifier">Roots</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">color</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">purple</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_identifier">MarkGray</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword">else</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_identifier">buffered</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">false</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_identifier">remove</span> <span class="ace_identifier">S</span> <span class="ace_keyword">from</span> <span class="ace_identifier">Roots</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">经</span> Release <span class="ace_cjk" style="width:NaNpx">却</span><span class="ace_cjk" style="width:NaNpx">仍</span><span class="ace_cjk" style="width:NaNpx">旧</span><span class="ace_cjk" style="width:NaNpx">在</span> buffer <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span>, <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span> free</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_keyword">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">color</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">black</span> <span class="ace_keyword">and</span> <span class="ace_identifier">RC</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">Free</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># ScanRoots() <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">于</span><span class="ace_cjk" style="width:NaNpx">执</span><span class="ace_cjk" style="width:NaNpx">行</span><span class="ace_cjk" style="width:NaNpx">过</span> MarkGray(S) <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">每</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span><span class="ace_cjk" style="width:NaNpx">执</span><span class="ace_cjk" style="width:NaNpx">行</span> Scan(S), </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">将</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span><span class="ace_cjk" style="width:NaNpx">子</span><span class="ace_cjk" style="width:NaNpx">图</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">白</span><span class="ace_cjk" style="width:NaNpx">色</span>, <span class="ace_cjk" style="width:NaNpx">或</span><span class="ace_cjk" style="width:NaNpx">者</span><span class="ace_cjk" style="width:NaNpx">将</span><span class="ace_cjk" style="width:NaNpx">生</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">子</span><span class="ace_cjk" style="width:NaNpx">图</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">黑</span><span class="ace_cjk" style="width:NaNpx">色</span>.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ScanRoots</span><span class="ace_paren ace_lparen">(</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_keyword">for</span> <span class="ace_identifier">S</span> <span class="ace_keyword">in</span> <span class="ace_identifier">Roots</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">Scan</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># CollectRoots() <span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">紧</span><span class="ace_cjk" style="width:NaNpx">随</span> ScanRoots <span class="ace_cjk" style="width:NaNpx">之</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">的</span> CollectCycles <span class="ace_cjk" style="width:NaNpx">阶</span><span class="ace_cjk" style="width:NaNpx">段</span>, </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">留</span><span class="ace_cjk" style="width:NaNpx">下</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">白</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span><span class="ace_cjk" style="width:NaNpx">都</span><span class="ace_cjk" style="width:NaNpx">将</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">从</span> Roots buffer <span class="ace_cjk" style="width:NaNpx">访</span><span class="ace_cjk" style="width:NaNpx">问</span><span class="ace_cjk" style="width:NaNpx">到</span>, <span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">将</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">回</span><span class="ace_cjk" style="width:NaNpx">收</span>. </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">阶</span><span class="ace_cjk" style="width:NaNpx">段</span><span class="ace_cjk" style="width:NaNpx">将</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">对</span> Roots buffer <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">每</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span><span class="ace_cjk" style="width:NaNpx">执</span><span class="ace_cjk" style="width:NaNpx">行</span> CollectWhite <span class="ace_cjk" style="width:NaNpx">进</span><span class="ace_cjk" style="width:NaNpx">行</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span><span class="ace_cjk" style="width:NaNpx">回</span><span class="ace_cjk" style="width:NaNpx">收</span>. </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span><span class="ace_cjk" style="width:NaNpx">都</span><span class="ace_cjk" style="width:NaNpx">将</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">从</span> Roots <span class="ace_cjk" style="width:NaNpx">缓</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">列</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span><span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">且</span><span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">除</span> buffered <span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span>.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">CollectRoots</span><span class="ace_paren ace_lparen">(</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_keyword">for</span> <span class="ace_identifier">S</span> <span class="ace_keyword">in</span> <span class="ace_identifier">Roots</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">remove</span> <span class="ace_identifier">S</span> <span class="ace_keyword">from</span> <span class="ace_identifier">Roots</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">buffered</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">false</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">CollectWhite</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># MarkGray(S) <span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">以</span> S <span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">图</span><span class="ace_cjk" style="width:NaNpx">执</span><span class="ace_cjk" style="width:NaNpx">行</span><span class="ace_cjk" style="width:NaNpx">深</span><span class="ace_cjk" style="width:NaNpx">度</span><span class="ace_cjk" style="width:NaNpx">优</span><span class="ace_cjk" style="width:NaNpx">先</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span>, </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">将</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">灰</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">且</span><span class="ace_cjk" style="width:NaNpx">减</span>1<span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">部</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span>.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">MarkGray</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_keyword">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">color</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">gray</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">color</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">gray</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword">for</span> <span class="ace_identifier">T</span> <span class="ace_keyword">in</span> <span class="ace_identifier">children</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_identifier">RC</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">T</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">RC</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">T</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">-</span> <span class="ace_constant ace_numeric">1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_identifier">MarkGray</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">T</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># Scan(S) <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">扫</span><span class="ace_cjk" style="width:NaNpx">描</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">大</span><span class="ace_cjk" style="width:NaNpx">于</span>0<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">灰</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span>, <span class="ace_cjk" style="width:NaNpx">则</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">明</span><span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">与</span><span class="ace_cjk" style="width:NaNpx">从</span><span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">达</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">活</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">据</span>, </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">此</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span> ScanBlack(S) <span class="ace_cjk" style="width:NaNpx">重</span><span class="ace_cjk" style="width:NaNpx">新</span><span class="ace_cjk" style="width:NaNpx">着</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">达</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">图</span>, <span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">恢</span><span class="ace_cjk" style="width:NaNpx">复</span><span class="ace_cjk" style="width:NaNpx">被</span> MarkGray <span class="ace_cjk" style="width:NaNpx">减</span><span class="ace_cjk" style="width:NaNpx">去</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span>. </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">但</span><span class="ace_cjk" style="width:NaNpx">是</span>, <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">扫</span><span class="ace_cjk" style="width:NaNpx">描</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">为</span>0<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">灰</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span>, <span class="ace_cjk" style="width:NaNpx">则</span><span class="ace_cjk" style="width:NaNpx">直</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">将</span><span class="ace_cjk" style="width:NaNpx">其</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">白</span><span class="ace_cjk" style="width:NaNpx">色</span>, <span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">且</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">子</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span> Scan. </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">注</span><span class="ace_cjk" style="width:NaNpx">意</span>, <span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">从</span><span class="ace_cjk" style="width:NaNpx">随</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">发</span><span class="ace_cjk" style="width:NaNpx">现</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">活</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">达</span><span class="ace_cjk" style="width:NaNpx">某</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">白</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span>, <span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">重</span><span class="ace_cjk" style="width:NaNpx">新</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">黑</span><span class="ace_cjk" style="width:NaNpx">色</span>.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">Scan</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_keyword">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">color</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">gray</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">RC</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">&gt;</span> <span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_identifier">ScanBlack</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword">else</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_identifier">color</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">white</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_keyword">for</span> <span class="ace_identifier">T</span> <span class="ace_keyword">in</span> <span class="ace_identifier">children</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">Scan</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">T</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># ScanBlack(S) <span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">执</span><span class="ace_cjk" style="width:NaNpx">行</span> MarkGray <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">逆</span><span class="ace_cjk" style="width:NaNpx">操</span><span class="ace_cjk" style="width:NaNpx">作</span>, <span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span>(<span class="ace_cjk" style="width:NaNpx">以</span> S <span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">图</span>),</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">将</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">重</span><span class="ace_cjk" style="width:NaNpx">新</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">黑</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">恢</span><span class="ace_cjk" style="width:NaNpx">复</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span>.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ScanBlack</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_identifier">color</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">black</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_keyword">for</span> <span class="ace_identifier">T</span> <span class="ace_keyword">in</span> <span class="ace_identifier">children</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">RC</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">T</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">RC</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">T</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_constant ace_numeric">1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">color</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">T</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">black</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_identifier">ScanBlack</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">T</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># CollectWhite(S) <span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">白</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">黑</span><span class="ace_cjk" style="width:NaNpx">色</span>. </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># <span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span> buffered <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">白</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">现</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span>, <span class="ace_cjk" style="width:NaNpx">而</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">之</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">在</span> Roots buffer <span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">扫</span><span class="ace_cjk" style="width:NaNpx">描</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">才</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span>.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">CollectWhite</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_keyword">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">color</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">white</span> <span class="ace_keyword">and</span> ! <span class="ace_identifier">buffered</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">color</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">black</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword">for</span> <span class="ace_identifier">T</span> <span class="ace_keyword">in</span> <span class="ace_identifier">children</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_identifier">CollectWhite</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">T</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">Free</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">S</span><span class="ace_paren ace_rparen">)</span>
</div></div></div></div><div class="cell text-cell"><hr></div><div class="cell text-cell"><div><b>Zend/zend_alloc.h</b><br></div></div><div class="cell code-cell"><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> ZEND_MM_OVERHEAD ZEND_MM_ALIGNED_SIZE(sizeof(zend_mm_debug_info))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#else</span> 
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> ZEND_MM_OVERHEAD 0</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div></div></div></div><div class="cell text-cell"><b>Zend/zend_types.h</b></div><div class="cell code-cell"><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#ifdef</span> <span class="ace_identifier">WORDS_BIGENDIAN</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> ZEND_ENDIAN_LOHI(lo, hi)          hi; lo;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> ZEND_ENDIAN_LOHI_3(lo, mi, hi)    hi; mi; lo;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> ZEND_ENDIAN_LOHI_4(a, b, c, d)    d; c; b; a;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> ZEND_ENDIAN_LOHI_C(lo, hi)        hi, lo</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> ZEND_ENDIAN_LOHI_C_3(lo, mi, hi)  hi, mi, lo,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> ZEND_ENDIAN_LOHI_C_4(a, b, c, d)  d, c, b, a</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#else</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> ZEND_ENDIAN_LOHI(lo, hi)          lo; hi;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> ZEND_ENDIAN_LOHI_3(lo, mi, hi)    lo; mi; hi;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> ZEND_ENDIAN_LOHI_4(a, b, c, d)    a; b; c; d;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> ZEND_ENDIAN_LOHI_C(lo, hi)        lo, hi</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> ZEND_ENDIAN_LOHI_C_3(lo, mi, hi)  lo, mi, hi,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> ZEND_ENDIAN_LOHI_C_4(a, b, c, d)  a, b, c, d</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">typedef</span> <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">_zend_refcounted_h</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">注</span><span class="ace_cjk" style="width:NaNpx">意</span>: <span class="ace_cjk" style="width:NaNpx">当</span>zend_refcounted_h* <span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">转</span><span class="ace_cjk" style="width:NaNpx">换</span><span class="ace_cjk" style="width:NaNpx">为</span> zend_mm_free_slot* <span class="ace_cjk" style="width:NaNpx">时</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// zend_mm_free_slot-&gt;next_free_slot<span class="ace_cjk" style="width:NaNpx">与</span>refcount <span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">重</span><span class="ace_cjk" style="width:NaNpx">合</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">某</span><span class="ace_cjk" style="width:NaNpx">些</span><span class="ace_cjk" style="width:NaNpx">错</span><span class="ace_cjk" style="width:NaNpx">误</span><span class="ace_cjk" style="width:NaNpx">下</span>, <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">经</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span>free_slot<span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">的</span>zend_refcounted_h*  </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// (<span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">是</span>zend_array*,zend_object*,...) <span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">减</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span>, <span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">破</span><span class="ace_cjk" style="width:NaNpx">坏</span>free_slot[n]<span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span>, </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">未</span><span class="ace_cjk" style="width:NaNpx">来</span><span class="ace_cjk" style="width:NaNpx">从</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">申</span><span class="ace_cjk" style="width:NaNpx">请</span><span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">时</span>, <span class="ace_cjk" style="width:NaNpx">造</span><span class="ace_cjk" style="width:NaNpx">成</span><span class="ace_cjk" style="width:NaNpx">段</span><span class="ace_cjk" style="width:NaNpx">错</span><span class="ace_cjk" style="width:NaNpx">误</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">uint32_t</span>         <span class="ace_identifier">refcount</span><span class="ace_punctuation ace_operator">;</span>          <span class="ace_comment">/* reference counter 32-bit */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">此</span><span class="ace_cjk" style="width:NaNpx">处</span>union<span class="ace_cjk" style="width:NaNpx">中</span>type_info<span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">方</span><span class="ace_cjk" style="width:NaNpx">便</span><span class="ace_cjk" style="width:NaNpx">同</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span>u.v, <span class="ace_cjk" style="width:NaNpx">比</span><span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">进</span><span class="ace_cjk" style="width:NaNpx">行</span><span class="ace_cjk" style="width:NaNpx">赋</span><span class="ace_cjk" style="width:NaNpx">值</span><span class="ace_cjk" style="width:NaNpx">时</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">union</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_storage ace_type">struct</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ZEND_ENDIAN_LOHI_3</span><span class="ace_paren ace_lparen">(</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_uchar</span>    <span class="ace_identifier">type</span><span class="ace_punctuation ace_operator">,</span>     <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">同</span> zval.u1.type</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_uchar</span>    <span class="ace_identifier">flags</span><span class="ace_punctuation ace_operator">,</span>    <span class="ace_comment">/* used for strings &amp; objects */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// gc_info <span class="ace_cjk" style="width:NaNpx">同</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">保</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">了</span><span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">前</span>ref<span class="ace_cjk" style="width:NaNpx">距</span><span class="ace_cjk" style="width:NaNpx">离</span>GC_G(roots)<span class="ace_cjk" style="width:NaNpx">多</span><span class="ace_cjk" style="width:NaNpx">少</span><span class="ace_cjk" style="width:NaNpx">个</span>gc_root_buffer<span class="ace_cjk" style="width:NaNpx">长</span><span class="ace_cjk" style="width:NaNpx">度</span><span class="ace_cjk" style="width:NaNpx">与</span>gc color</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">高</span>1<span class="ace_cjk" style="width:NaNpx">位</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">两</span><span class="ace_cjk" style="width:NaNpx">个</span>bit<span class="ace_cjk" style="width:NaNpx">保</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">信</span><span class="ace_cjk" style="width:NaNpx">息</span>, <span class="ace_cjk" style="width:NaNpx">剩</span><span class="ace_cjk" style="width:NaNpx">下</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">前</span>ref<span class="ace_cjk" style="width:NaNpx">距</span><span class="ace_cjk" style="width:NaNpx">离</span>GC_G(buf)<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// ?? 0xffff<span class="ace_cjk" style="width:NaNpx">即</span>65535 <span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">考</span><span class="ace_cjk" style="width:NaNpx">虑</span> additional_buffer, <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">小</span><span class="ace_cjk" style="width:NaNpx">为</span>1<span class="ace_cjk" style="width:NaNpx">，</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">大</span><span class="ace_cjk" style="width:NaNpx">为</span>10000</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">之</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">以</span>roots[0]<span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">申</span><span class="ace_cjk" style="width:NaNpx">请</span><span class="ace_cjk" style="width:NaNpx">到</span>(<span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">小</span><span class="ace_cjk" style="width:NaNpx">值</span><span class="ace_cjk" style="width:NaNpx">为</span>1), <span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">为</span>BLACK<span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">且</span><span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">为</span>0, gc_info 0x00000000 <span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">示</span> <span class="ace_cjk" style="width:NaNpx">无</span>gc_info <span class="ace_cjk" style="width:NaNpx">未</span><span class="ace_cjk" style="width:NaNpx">参</span><span class="ace_cjk" style="width:NaNpx">与</span>gc</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">还</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">好</span><span class="ace_cjk" style="width:NaNpx">处</span><span class="ace_cjk" style="width:NaNpx">是</span>, <span class="ace_cjk" style="width:NaNpx">非</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span>(black)<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">两</span><span class="ace_cjk" style="width:NaNpx">个</span> bit <span class="ace_cjk" style="width:NaNpx">都</span><span class="ace_cjk" style="width:NaNpx">为</span>0, black <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">的</span> gc_info == <span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span> GC_G(buf)<span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">uint16_t</span>      <span class="ace_identifier">gc_info</span><span class="ace_paren ace_rparen">)</span>  <span class="ace_comment">/* keeps GC root number (or 0) and color */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_identifier">v</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">uint32_t</span> <span class="ace_identifier">type_info</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_identifier">u</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span> <span class="ace_identifier">zend_refcounted_h</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">struct</span> <span class="ace_identifier">_zend_refcounted</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">zend_refcounted_h</span> <span class="ace_identifier">gc</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> Z_TYPE_FLAGS(zval)          (zval).u1.v.type_flags</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> Z_TYPE_FLAGS_P(zval_p)      Z_TYPE_FLAGS(*(zval_p))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_REFCOUNT(p)              (p)-&gt;gc.refcount</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_TYPE(p)                  (p)-&gt;gc.u.v.type</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_FLAGS(p)                 (p)-&gt;gc.u.v.flags</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_INFO(p)                  (p)-&gt;gc.u.v.gc_info</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_TYPE_INFO(p)             (p)-&gt;gc.u.type_info</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> Z_GC_TYPE(zval)             GC_TYPE(Z_COUNTED(zval))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> Z_GC_TYPE_P(zval_p)         Z_GC_TYPE(*(zval_p))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> Z_GC_FLAGS(zval)            GC_FLAGS(Z_COUNTED(zval))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> Z_GC_FLAGS_P(zval_p)        Z_GC_FLAGS(*(zval_p))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> Z_GC_INFO(zval)             GC_INFO(Z_COUNTED(zval))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> Z_GC_INFO_P(zval_p)         Z_GC_INFO(*(zval_p))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> Z_GC_TYPE_INFO(zval)        GC_TYPE_INFO(Z_COUNTED(zval))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> Z_GC_TYPE_INFO_P(zval_p)    Z_GC_TYPE_INFO(*(zval_p))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_FLAGS_SHIFT          8</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_INFO_SHIFT               16</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// 11111111111111110000000000000000</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_INFO_MASK                0xffff0000</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">/* zval.value-&gt;gc.u.v.flags */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_COLLECTABLE              (1&lt;&lt;7) </span><span class="ace_comment">// 10000000</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">/*</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">#define IS_ARRAY    7</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">#define IS_OBJECT   8</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">*/</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// 1000000000000111</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_ARRAY                    (IS_ARRAY          | (GC_COLLECTABLE &lt;&lt; GC_FLAGS_SHIFT))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// 1000000000001000</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_OBJECT                   (IS_OBJECT         | (GC_COLLECTABLE &lt;&lt; GC_FLAGS_SHIFT))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">/* zval.u1.v.type_flags */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> IS_TYPE_CONSTANT            (1&lt;&lt;0) </span><span class="ace_comment">// 0001</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> IS_TYPE_REFCOUNTED      (1&lt;&lt;2) </span><span class="ace_comment">// 0100</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> IS_TYPE_COPYABLE            (1&lt;&lt;4) </span><span class="ace_comment">// 1000</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">/* object flags (zval.value-&gt;gc.u.flags) */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> IS_OBJ_APPLY_COUNT            0x07</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> IS_OBJ_DESTRUCTOR_CALLED    (1&lt;&lt;3)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> IS_OBJ_FREE_CALLED            (1&lt;&lt;4)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> IS_OBJ_USE_GUARDS         (1&lt;&lt;5)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> IS_OBJ_HAS_GUARDS         (1&lt;&lt;6)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> Z_REFCOUNTED(zval)          ((Z_TYPE_FLAGS(zval) &amp; IS_TYPE_REFCOUNTED) != 0)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> Z_REFCOUNTED_P(zval_p)  Z_REFCOUNTED(*(zval_p))</span>
</div></div></div></div><div class="cell text-cell"><b>Zend/zend_gc.h</b></div><div class="cell code-cell"><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">/*</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   +----------------------------------------------------------------------+</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | Zend Engine                                                          |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   +----------------------------------------------------------------------+</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | Copyright (c) 1998-2017 Zend Technologies Ltd. (http://www.zend.com) |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   +----------------------------------------------------------------------+</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | This source file is subject to version 2.00 of the Zend license,     |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | that is bundled with this package in the file LICENSE, and is        |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | available through the world-wide-web at the following url:           |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | http://www.zend.com/license/2_00.txt.                                |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | If you did not receive a copy of the Zend license and are unable to  |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | obtain it through the world-wide-web, please send a note to          |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | license@zend.com so we can mail you a copy immediately.              |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   +----------------------------------------------------------------------+</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | Authors: David Wang &lt;planetbeing@gmail.com&gt;                          |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   |          Dmitry Stogov &lt;dmitry@zend.com&gt;                             |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   +----------------------------------------------------------------------+</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">*/</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">/* $Id$ */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#ifndef</span> <span class="ace_identifier">ZEND_GC_H</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> ZEND_GC_H</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#ifndef</span> <span class="ace_identifier">GC_BENCH</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> GC_BENCH 0</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#if</span> <span class="ace_identifier">GC_BENCH</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> GC_BENCH_INC(counter) GC_G(counter)++</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> GC_BENCH_DEC(counter) GC_G(counter)--</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other ace_multiline"> GC_BENCH_PEAK(peak, counter) do {      \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_constant ace_other ace_multiline">    if (GC_G(counter) &gt; GC_G(peak)) {       \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_constant ace_other ace_multiline">    GC_G(peak) = GC_G(counter);         \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_constant ace_other ace_multiline">    }                                       \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other">    } while (0)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#else</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> GC_BENCH_INC(counter)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> GC_BENCH_DEC(counter)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> GC_BENCH_PEAK(peak, counter)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// php -r 'echo decbin(0xc000);'</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// 1100000000000000 mask</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_COLOR  0xc000</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// 0000000000000000</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_BLACK  0x0000</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// 1000000000000000</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_WHITE  0x8000</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// 0100000000000000</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_GREY   0x4000</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// 1100000000000000</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_PURPLE 0xc000</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">除</span><span class="ace_cjk" style="width:NaNpx">高</span><span class="ace_cjk" style="width:NaNpx">位</span><span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">信</span><span class="ace_cjk" style="width:NaNpx">息</span>(<span class="ace_cjk" style="width:NaNpx">两</span><span class="ace_cjk" style="width:NaNpx">个</span>bit<span class="ace_cjk" style="width:NaNpx">位</span>)<span class="ace_cjk" style="width:NaNpx">即</span><span class="ace_cjk" style="width:NaNpx">低</span><span class="ace_cjk" style="width:NaNpx">位</span><span class="ace_cjk" style="width:NaNpx">地</span><span class="ace_cjk" style="width:NaNpx">址</span><span class="ace_cjk" style="width:NaNpx">信</span><span class="ace_cjk" style="width:NaNpx">息</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// v: zend_refcounted_h.u.v.gc_info</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other ace_multiline"> GC_ADDRESS(v) \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other">    ((v) &amp; ~GC_COLOR)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other ace_multiline"> GC_INFO_GET_COLOR(v) \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other">    (((zend_uintptr_t)(v)) &amp; GC_COLOR)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// v &amp; GC_COLOR <span class="ace_cjk" style="width:NaNpx">保</span><span class="ace_cjk" style="width:NaNpx">留</span><span class="ace_cjk" style="width:NaNpx">原</span><span class="ace_cjk" style="width:NaNpx">来</span><span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">信</span><span class="ace_cjk" style="width:NaNpx">息</span>, | a <span class="ace_cjk" style="width:NaNpx">重</span><span class="ace_cjk" style="width:NaNpx">新</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span><span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">地</span><span class="ace_cjk" style="width:NaNpx">址</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other ace_multiline"> GC_INFO_SET_ADDRESS(v, a) \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other">    do {(v) = ((v) &amp; GC_COLOR) | (a);} while (0)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// &amp; ~GC_COLOR <span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span><span class="ace_cjk" style="width:NaNpx">原</span><span class="ace_cjk" style="width:NaNpx">来</span>color, | c <span class="ace_cjk" style="width:NaNpx">设</span><span class="ace_cjk" style="width:NaNpx">置</span><span class="ace_cjk" style="width:NaNpx">新</span>color</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other ace_multiline"> GC_INFO_SET_COLOR(v, c) \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other">    do {(v) = ((v) &amp; ~GC_COLOR) | (c);} while (0)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// black<span class="ace_cjk" style="width:NaNpx">即</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span>bit<span class="ace_cjk" style="width:NaNpx">位</span><span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">零</span><span class="ace_cjk" style="width:NaNpx">即</span><span class="ace_cjk" style="width:NaNpx">可</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other ace_multiline"> GC_INFO_SET_BLACK(v) \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other">    do {(v) = (v) &amp; ~GC_COLOR;} while (0)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// purple<span class="ace_cjk" style="width:NaNpx">两</span><span class="ace_cjk" style="width:NaNpx">个</span>bit<span class="ace_cjk" style="width:NaNpx">全</span><span class="ace_cjk" style="width:NaNpx">部</span><span class="ace_cjk" style="width:NaNpx">为</span>1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other ace_multiline"> GC_INFO_SET_PURPLE(v) \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other">    do {(v) = (v) | GC_COLOR;} while (0)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">保</span><span class="ace_cjk" style="width:NaNpx">存</span> zend_refcounted* <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// zend_refcounted* <span class="ace_cjk" style="width:NaNpx">即</span> zval* <span class="ace_cjk" style="width:NaNpx">但</span><span class="ace_cjk" style="width:NaNpx">只</span><span class="ace_cjk" style="width:NaNpx">包</span><span class="ace_cjk" style="width:NaNpx">括</span><span class="ace_cjk" style="width:NaNpx">有</span> gc<span class="ace_cjk" style="width:NaNpx">结</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">的</span> zend_object, zend_array, </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">//                      zend_reference(<span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">实</span><span class="ace_cjk" style="width:NaNpx">际</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">向</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span>))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">typedef</span> <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">_gc_root_buffer</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">zend_refcounted</span>          <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">_gc_root_buffer</span>   <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>     <span class="ace_comment">/* double-linked list               */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">_gc_root_buffer</span>   <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">prev</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">的</span> refcount <span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">段</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">来</span><span class="ace_cjk" style="width:NaNpx">在</span>GC <span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">理</span><span class="ace_cjk" style="width:NaNpx">阶</span><span class="ace_cjk" style="width:NaNpx">段</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span> dtor <span class="ace_cjk" style="width:NaNpx">前</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">录</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">前</span> refcount</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">来</span><span class="ace_cjk" style="width:NaNpx">发</span><span class="ace_cjk" style="width:NaNpx">现</span> zend_object <span class="ace_cjk" style="width:NaNpx">析</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span> <span class="ace_cjk" style="width:NaNpx">导</span><span class="ace_cjk" style="width:NaNpx">致</span> zend_refcounted refcount <span class="ace_cjk" style="width:NaNpx">增</span><span class="ace_cjk" style="width:NaNpx">加</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">uint32_t</span>                 <span class="ace_identifier">refcount</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span> <span class="ace_identifier">gc_root_buffer</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">每</span><span class="ace_cjk" style="width:NaNpx">块</span> gc_additional_buffer <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">大</span><span class="ace_cjk" style="width:NaNpx">小</span> <span class="ace_cjk" style="width:NaNpx">为</span>4k, <span class="ace_cjk" style="width:NaNpx">在</span>32<span class="ace_cjk" style="width:NaNpx">位</span><span class="ace_cjk" style="width:NaNpx">和</span>64<span class="ace_cjk" style="width:NaNpx">位</span><span class="ace_cjk" style="width:NaNpx">平</span><span class="ace_cjk" style="width:NaNpx">台</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">容</span><span class="ace_cjk" style="width:NaNpx">纳</span><span class="ace_cjk" style="width:NaNpx">的</span> gc_root_buffer <span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">样</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// 4k <span class="ace_cjk" style="width:NaNpx">大</span><span class="ace_cjk" style="width:NaNpx">小</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">原</span><span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">应</span><span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">基</span><span class="ace_cjk" style="width:NaNpx">于</span> zend_mm <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">考</span><span class="ace_cjk" style="width:NaNpx">量</span>, <span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span>zend <span class="ace_cjk" style="width:NaNpx">的</span> page = 4k</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">什</span><span class="ace_cjk" style="width:NaNpx">么</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">减</span><span class="ace_cjk" style="width:NaNpx">两</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">针</span><span class="ace_cjk" style="width:NaNpx">大</span><span class="ace_cjk" style="width:NaNpx">小</span>?? <span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">为</span> _gc_additional_bufer.next <span class="ace_cjk" style="width:NaNpx">与</span> _gc_additional_bufer.used(64<span class="ace_cjk" style="width:NaNpx">位</span><span class="ace_cjk" style="width:NaNpx">平</span><span class="ace_cjk" style="width:NaNpx">台</span><span class="ace_cjk" style="width:NaNpx">考</span><span class="ace_cjk" style="width:NaNpx">虑</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">结</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">体</span><span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">齐</span>)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other ace_multiline"> GC_NUM_ADDITIONAL_ENTRIES \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other">    ((4096 - ZEND_MM_OVERHEAD - sizeof(void*) * 2) </span><span class="ace_keyword ace_operator">/</span> <span class="ace_keyword ace_operator">sizeof</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_root_buffer</span><span class="ace_paren ace_rparen">))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">typedef</span> <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">_gc_additional_bufer</span> <span class="ace_identifier">gc_additional_buffer</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// 4k <span class="ace_cjk" style="width:NaNpx">连</span><span class="ace_cjk" style="width:NaNpx">续</span><span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">的</span> gc_root_buffer</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">struct</span> <span class="ace_identifier">_gc_additional_bufer</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">该</span> buffer <span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">使</span><span class="ace_cjk" style="width:NaNpx">用</span> buf idx</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">uint32_t</span>              <span class="ace_identifier">used</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_additional_buffer</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_root_buffer</span>        <span class="ace_identifier">buf</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">GC_NUM_ADDITIONAL_ENTRIES</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">;</span> <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">义</span><span class="ace_cjk" style="width:NaNpx">同</span>zend_gc_globals.buf</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">typedef</span> <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">_zend_gc_globals</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// gc <span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">否</span><span class="ace_cjk" style="width:NaNpx">开</span><span class="ace_cjk" style="width:NaNpx">启</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">zend_bool</span>         <span class="ace_identifier">gc_enabled</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">前</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">否</span><span class="ace_cjk" style="width:NaNpx">在</span> gc <span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">程</span><span class="ace_cjk" style="width:NaNpx">中</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">zend_bool</span>         <span class="ace_identifier">gc_active</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// roots <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">否</span><span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">满</span>(<span class="ace_cjk" style="width:NaNpx">容</span><span class="ace_cjk" style="width:NaNpx">量</span>10000), <span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">动</span><span class="ace_cjk" style="width:NaNpx">触</span><span class="ace_cjk" style="width:NaNpx">发</span> gc <span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">zend_bool</span>         <span class="ace_identifier">gc_full</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// gc_root_buffer <span class="ace_cjk" style="width:NaNpx">预</span><span class="ace_cjk" style="width:NaNpx">申</span><span class="ace_cjk" style="width:NaNpx">请</span><span class="ace_cjk" style="width:NaNpx">空</span><span class="ace_cjk" style="width:NaNpx">间</span>, roots <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">与</span> unused <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">空</span><span class="ace_cjk" style="width:NaNpx">间</span><span class="ace_cjk" style="width:NaNpx">都</span><span class="ace_cjk" style="width:NaNpx">赖</span><span class="ace_cjk" style="width:NaNpx">在</span> buf</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// first_unused <span class="ace_cjk" style="width:NaNpx">与</span> last_unused <span class="ace_cjk" style="width:NaNpx">分</span><span class="ace_cjk" style="width:NaNpx">别</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">向</span> <span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">用</span> gc_root_buffer <span class="ace_cjk" style="width:NaNpx">开</span><span class="ace_cjk" style="width:NaNpx">始</span><span class="ace_cjk" style="width:NaNpx">与</span><span class="ace_cjk" style="width:NaNpx">结</span><span class="ace_cjk" style="width:NaNpx">束</span>, <span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">连</span><span class="ace_cjk" style="width:NaNpx">续</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_root_buffer</span>   <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">buf</span><span class="ace_punctuation ace_operator">;</span>              <span class="ace_comment">/* preallocated arrays of buffers   */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// Roots buffer <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">头</span>, <span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">向</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span><span class="ace_cjk" style="width:NaNpx">的</span> <span class="ace_cjk" style="width:NaNpx">的</span> gc_root_buffer,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">为</span> <span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">程</span>: gc_root_buffer <span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">从</span><span class="ace_cjk" style="width:NaNpx">连</span><span class="ace_cjk" style="width:NaNpx">续</span><span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">空</span><span class="ace_cjk" style="width:NaNpx">间</span> <span class="ace_cjk" style="width:NaNpx">的</span> buf <span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">出</span>, <span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span> roots, </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">之</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span><span class="ace_cjk" style="width:NaNpx">转</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">到</span> unused, <span class="ace_cjk" style="width:NaNpx">又</span><span class="ace_cjk" style="width:NaNpx">重</span><span class="ace_cjk" style="width:NaNpx">新</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">从</span> unused <span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">出</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span> roots, <span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">以</span>, roots <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">连</span><span class="ace_cjk" style="width:NaNpx">续</span><span class="ace_cjk" style="width:NaNpx">的</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_root_buffer</span>    <span class="ace_identifier">roots</span><span class="ace_punctuation ace_operator">;</span>            <span class="ace_comment">/* list of possible roots of cycles */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">经</span><span class="ace_cjk" style="width:NaNpx">从</span> buf <span class="ace_cjk" style="width:NaNpx">申</span><span class="ace_cjk" style="width:NaNpx">请</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">的</span> gc_root_buffer, <span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span><span class="ace_cjk" style="width:NaNpx">到</span> roots, <span class="ace_cjk" style="width:NaNpx">之</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">再</span><span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">候</span>, <span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">转</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">到</span> unused <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span> gc_root_buffer<span class="ace_cjk" style="width:NaNpx">优</span><span class="ace_cjk" style="width:NaNpx">先</span><span class="ace_cjk" style="width:NaNpx">从</span> unused <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_root_buffer</span>   <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">unused</span><span class="ace_punctuation ace_operator">;</span>           <span class="ace_comment">/* list of unused buffers           */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">向</span> buf <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">块</span><span class="ace_cjk" style="width:NaNpx">未</span><span class="ace_cjk" style="width:NaNpx">使</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">的</span> gc_root_buffer</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">注</span><span class="ace_cjk" style="width:NaNpx">意</span>: <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">初</span><span class="ace_cjk" style="width:NaNpx">始</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">向</span>  (GC_G(buf) + 1), <span class="ace_cjk" style="width:NaNpx">即</span><span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">二</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">原</span><span class="ace_cjk" style="width:NaNpx">因</span>:  zend_refcounted_h.u.v.gc_info <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">保</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">前</span> gc_root_buffer <span class="ace_cjk" style="width:NaNpx">距</span><span class="ace_cjk" style="width:NaNpx">离</span> buf <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">相</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">地</span><span class="ace_cjk" style="width:NaNpx">址</span>, e.g.  buf - GC_G(buf)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">//      <span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">块</span> gc_root_buffer <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">相</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">地</span><span class="ace_cjk" style="width:NaNpx">址</span><span class="ace_cjk" style="width:NaNpx">为</span> 0, <span class="ace_cjk" style="width:NaNpx">而</span> <span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span> <span class="ace_cjk" style="width:NaNpx">黑</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">的</span> gc_info <span class="ace_cjk" style="width:NaNpx">等</span><span class="ace_cjk" style="width:NaNpx">于</span> 0 <span class="ace_cjk" style="width:NaNpx">时</span> <span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">来</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">示</span><span class="ace_cjk" style="width:NaNpx">无</span> gc_info, </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">//        <span class="ace_cjk" style="width:NaNpx">即</span> <span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">前</span> refcountd_h <span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">在</span> Root buffer <span class="ace_cjk" style="width:NaNpx">中</span>, <span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">以</span> 0 <span class="ace_cjk" style="width:NaNpx">舍</span><span class="ace_cjk" style="width:NaNpx">弃</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">用</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_root_buffer</span>   <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">first_unused</span><span class="ace_punctuation ace_operator">;</span>     <span class="ace_comment">/* pointer to first unused buffer   */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// &amp;gc_globals.buf[10001]</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_root_buffer</span>   <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">last_unused</span><span class="ace_punctuation ace_operator">;</span>      <span class="ace_comment">/* pointer to last unused buffer    */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_root_buffer</span>    <span class="ace_identifier">to_free</span><span class="ace_punctuation ace_operator">;</span>          <span class="ace_comment">/* list to free                     */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// gc <span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span><span class="ace_cjk" style="width:NaNpx">阶</span><span class="ace_cjk" style="width:NaNpx">段</span>, <span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">向</span>next<span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span><span class="ace_cjk" style="width:NaNpx">的</span> gc_root_buffer</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_root_buffer</span>   <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">next_to_free</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// gc <span class="ace_cjk" style="width:NaNpx">运</span><span class="ace_cjk" style="width:NaNpx">行</span><span class="ace_cjk" style="width:NaNpx">次</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">统</span><span class="ace_cjk" style="width:NaNpx">计</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">uint32_t</span> <span class="ace_identifier">gc_runs</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// gc <span class="ace_cjk" style="width:NaNpx">回</span><span class="ace_cjk" style="width:NaNpx">收</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">量</span><span class="ace_cjk" style="width:NaNpx">统</span><span class="ace_cjk" style="width:NaNpx">计</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">uint32_t</span> <span class="ace_identifier">collected</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#if</span> <span class="ace_identifier">GC_BENCH</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">uint32_t</span> <span class="ace_identifier">root_buf_length</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">uint32_t</span> <span class="ace_identifier">root_buf_peak</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">uint32_t</span> <span class="ace_identifier">zval_possible_root</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">uint32_t</span> <span class="ace_identifier">zval_buffered</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">uint32_t</span> <span class="ace_identifier">zval_remove_from_buffer</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">uint32_t</span> <span class="ace_identifier">zval_marked_grey</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// 4k<span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">存</span>buffer <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span>, <span class="ace_cjk" style="width:NaNpx">每</span><span class="ace_cjk" style="width:NaNpx">块</span> bufer <span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">固</span><span class="ace_cjk" style="width:NaNpx">定</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">量</span><span class="ace_cjk" style="width:NaNpx">的</span> gc_root_buffer(<span class="ace_cjk" style="width:NaNpx">依</span><span class="ace_cjk" style="width:NaNpx">平</span><span class="ace_cjk" style="width:NaNpx">台</span><span class="ace_cjk" style="width:NaNpx">而</span><span class="ace_cjk" style="width:NaNpx">定</span>)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_additional_buffer</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">additional_buffer</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span> <span class="ace_identifier">zend_gc_globals</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#ifdef</span> <span class="ace_identifier">ZTS</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">BEGIN_EXTERN_C</span><span class="ace_paren ace_lparen">(</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_storage ace_modifier">extern</span> <span class="ace_storage ace_type">int</span> <span class="ace_identifier">gc_globals_id</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">END_EXTERN_C</span><span class="ace_paren ace_lparen">(</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_G(v) ZEND_TSRMG(gc_globals_id, zend_gc_globals *, v)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#else</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_G(v) (gc_globals.v)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">extern</span> <span class="ace_identifier">ZEND_API</span> <span class="ace_identifier">zend_gc_globals</span> <span class="ace_identifier">gc_globals</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">BEGIN_EXTERN_C</span><span class="ace_paren ace_lparen">(</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_storage ace_modifier">extern</span> <span class="ace_storage ace_type">int</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">*</span><span class="ace_identifier">gc_collect_cycles</span><span class="ace_paren ace_rparen">)</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">ZEND_FASTCALL</span> <span class="ace_identifier">gc_possible_root</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_refcounted</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">ZEND_FASTCALL</span> <span class="ace_identifier">gc_remove_from_buffer</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_refcounted</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_globals_ctor</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_globals_dtor</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_init</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_reset</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">/* The default implementation of the gc_collect_cycles callback. */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_storage ace_type">int</span>  <span class="ace_identifier">zend_gc_collect_cycles</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">END_EXTERN_C</span><span class="ace_paren ace_lparen">(</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// gc_remove_from_buffer <span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">除</span><span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">与</span><span class="ace_cjk" style="width:NaNpx">地</span><span class="ace_cjk" style="width:NaNpx">址</span> GC_INFO(ref) = 0;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">没</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">地</span><span class="ace_cjk" style="width:NaNpx">址</span><span class="ace_cjk" style="width:NaNpx">说</span><span class="ace_cjk" style="width:NaNpx">明</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">在</span> Roots buffer <span class="ace_cjk" style="width:NaNpx">中</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other ace_multiline"> GC_REMOVE_FROM_BUFFER(p) do { \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_constant ace_other ace_multiline">    zend_refcounted *_p = (zend_refcounted*)(p); \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_constant ace_other ace_multiline">    if (GC_ADDRESS(GC_INFO(_p))) { \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_constant ace_other ace_multiline">    gc_remove_from_buffer(_p); \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_constant ace_other ace_multiline">    } \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other">    } while (0)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">/*</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">union {</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">    struct {</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_comment">    ZEND_ENDIAN_LOHI_3(</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_comment">    zend_uchar    type,     // <span class="ace_cjk" style="width:NaNpx">同</span> zval.u1.type</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_comment">    zend_uchar    flags,    // used for strings &amp; objects</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_comment">    uint16_t      gc_info  // keeps GC root number (or 0) and color</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">    )} v;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">    uint32_t type_info;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">} u;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">*/</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// gc_info == 0</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// (ref-&gt;gc.u.type_info &amp; (11111111111111110000000000000000 | 1000000000000000 ))    == 1000000000000000</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other ace_multiline"> GC_MAY_LEAK(ref) \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other ace_multiline">    ((GC_TYPE_INFO(ref) &amp; \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_constant ace_other ace_multiline">    (GC_INFO_MASK | (GC_COLLECTABLE &lt;&lt; GC_FLAGS_SHIFT))) == \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other">    (GC_COLLECTABLE &lt;&lt; GC_FLAGS_SHIFT))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">static</span> <span class="ace_identifier">zend_always_inline</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_check_possible_root</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_refcounted</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">型</span>ref<span class="ace_cjk" style="width:NaNpx">执</span><span class="ace_cjk" style="width:NaNpx">行</span>, <span class="ace_cjk" style="width:NaNpx">相</span><span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">于</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span>ref(<span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span>)<span class="ace_cjk" style="width:NaNpx">执</span><span class="ace_cjk" style="width:NaNpx">行</span>gc_possible_root</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_REFERENCE</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zval</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_paren ace_lparen">((</span><span class="ace_identifier">zend_reference</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// zv.u1.v.type_flags &amp; (1&lt;&lt;2)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// gc_info = 0</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">UNEXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_MAY_LEAK</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_possible_root</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span> <span class="ace_comment">/* ZEND_GC_H */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">/*</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * Local variables:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * tab-width: 4</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * c-basic-offset: 4</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * indent-tabs-mode: t</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * End:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div></div></div></div><div class="cell code-cell"><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">/*</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   +----------------------------------------------------------------------+</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | Zend Engine                                                          |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   +----------------------------------------------------------------------+</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | Copyright (c) 1998-2017 Zend Technologies Ltd. (http://www.zend.com) |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   +----------------------------------------------------------------------+</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | This source file is subject to version 2.00 of the Zend license,     |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | that is bundled with this package in the file LICENSE, and is        |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | available through the world-wide-web at the following url:           |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | http://www.zend.com/license/2_00.txt.                                |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | If you did not receive a copy of the Zend license and are unable to  |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | obtain it through the world-wide-web, please send a note to          |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | license@zend.com so we can mail you a copy immediately.              |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   +----------------------------------------------------------------------+</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   | Authors: David Wang &lt;planetbeing@gmail.com&gt;                          |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   |          Dmitry Stogov &lt;dmitry@zend.com&gt;                             |</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">   +----------------------------------------------------------------------+</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">*/</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">/* $Id$ */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc">/**</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * zend_gc_collect_cycles</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * ======================</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> *</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * Colors and its meaning</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * ----------------------</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> *</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * BLACK  (GC_BLACK)   - In use or free.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * GREY   (GC_GREY)    - Possible member of cycle.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * WHITE  (GC_WHITE)   - Member of garbage cycle.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * PURPLE (GC_PURPLE)  - Possible root of cycle.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> *</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * Colors described in the paper but not used</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * ------------------------------------------</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> *</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * GREEN - Acyclic</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * RED   - Candidate cycle underogin</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * ORANGE - Candidate cycle awaiting epoch boundary.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> *</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> *</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * Flow</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * =====</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> *</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * The garbage collect cycle starts from 'gc_mark_roots', which traverses the</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * possible roots, and calls mark_grey for roots are marked purple with</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * depth-first traverse.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> *</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * After all possible roots are traversed and marked,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * gc_scan_roots will be called, and each root will be called with</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * gc_scan(root-&gt;ref)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> *</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * gc_scan checkes the colors of possible members.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> *</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * If the node is marked as grey and the refcount &gt; 0</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> *    gc_scan_black will be called on that node to scan it's subgraph.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * otherwise (refcount == 0), it marks the node white.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> *</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * A node MAY be added to possbile roots when ZEND_UNSET_VAR happens or</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * zend_assign_to_variable is called only when possible garbage node is</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * produced.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * gc_possible_root() will be called to add the nodes to possible roots.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> *</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> *</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * For objects, we call their get_gc handler (by default 'zend_std_get_gc') to</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * get the object properties to scan.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> *</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> *</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> * </span><span class="ace_comment ace_doc ace_tag">@see</span><span class="ace_comment ace_doc"> http://researcher.watson.ibm.com/researcher/files/us-bacon/Bacon01Concurrent.pdf</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment ace_doc"> */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#include</span><span class="ace_constant ace_other"> "zend.h"</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#include</span><span class="ace_constant ace_other"> "zend_API.h"</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">/* one (0) is reserved */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_ROOT_BUFFER_MAX_ENTRIES 10001</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// ?</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> GC_HAS_DESTRUCTORS  (1&lt;&lt;0)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#ifndef</span> <span class="ace_identifier">ZEND_GC_DEBUG</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> ZEND_GC_DEBUG 0</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#ifdef</span> <span class="ace_identifier">ZTS</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_storage ace_type">int</span> <span class="ace_identifier">gc_globals_id</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#else</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_identifier">zend_gc_globals</span> <span class="ace_identifier">gc_globals</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_storage ace_type">int</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">*</span><span class="ace_identifier">gc_collect_cycles</span><span class="ace_paren ace_rparen">)</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#if</span> <span class="ace_identifier">ZEND_GC_DEBUG</span> <span class="ace_keyword ace_operator">&gt;</span> <span class="ace_constant ace_numeric">1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other ace_multiline"> GC_TRACE(format, ...) fprintf(stderr, format "\</span><span class="ace_constant ace_other">n", ##__VA_ARGS__);</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other ace_multiline"> GC_TRACE_REF(ref, format, ...) \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other ace_multiline">    do { \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_constant ace_other ace_multiline">    gc_trace_ref((zend_refcounted *) ref); \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_constant ace_other ace_multiline">    fprintf(stderr, format "\n", ##__VA_ARGS__); \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other">    } while (0)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other ace_multiline"> GC_TRACE_SET_COLOR(ref, color) \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other">    GC_TRACE_REF(ref, "-&gt;%s", gc_color_name(color))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#else</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> GC_TRACE_REF(ref, format, ...)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> GC_TRACE_SET_COLOR(ref, new_color)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword"># define</span><span class="ace_constant ace_other"> GC_TRACE(str)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other ace_multiline"> GC_REF_SET_ADDRESS(ref, a) \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other">    GC_INFO_SET_ADDRESS(GC_INFO(ref), a)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other ace_multiline"> GC_REF_GET_COLOR(ref) \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other">    GC_INFO_GET_COLOR(GC_INFO(ref))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other ace_multiline"> GC_REF_SET_COLOR(ref, c) \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other">    do { GC_TRACE_SET_COLOR(ref, c); GC_INFO_SET_COLOR(GC_INFO(ref), c); } while (0)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other ace_multiline"> GC_REF_SET_BLACK(ref) \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other">    do { GC_TRACE_SET_COLOR(ref, GC_BLACK); GC_INFO_SET_BLACK(GC_INFO(ref)); } while (0)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other ace_multiline"> GC_REF_SET_PURPLE(ref) \</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_constant ace_other">    do { GC_TRACE_SET_COLOR(ref, GC_PURPLE); GC_INFO_SET_PURPLE(GC_INFO(ref)); } while (0)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#if</span> <span class="ace_identifier">ZEND_GC_DEBUG</span> <span class="ace_keyword ace_operator">&gt;</span> <span class="ace_constant ace_numeric">1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">static</span> <span class="ace_storage ace_modifier">const</span> <span class="ace_storage ace_type">char</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">gc_color_name</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">uint32_t</span> <span class="ace_identifier">color</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">switch</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">color</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">case</span> <span class="ace_identifier">GC_BLACK</span><span class="ace_punctuation ace_operator">:</span> <span class="ace_keyword ace_control">return</span> <span class="ace_string ace_start">"</span><span class="ace_string">black</span><span class="ace_string ace_end">"</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">case</span> <span class="ace_identifier">GC_WHITE</span><span class="ace_punctuation ace_operator">:</span> <span class="ace_keyword ace_control">return</span> <span class="ace_string ace_start">"</span><span class="ace_string">white</span><span class="ace_string ace_end">"</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">case</span> <span class="ace_identifier">GC_GREY</span><span class="ace_punctuation ace_operator">:</span> <span class="ace_keyword ace_control">return</span> <span class="ace_string ace_start">"</span><span class="ace_string">grey</span><span class="ace_string ace_end">"</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">case</span> <span class="ace_identifier">GC_PURPLE</span><span class="ace_punctuation ace_operator">:</span> <span class="ace_keyword ace_control">return</span> <span class="ace_string ace_start">"</span><span class="ace_string">purple</span><span class="ace_string ace_end">"</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">default</span><span class="ace_punctuation ace_operator">:</span> <span class="ace_keyword ace_control">return</span> <span class="ace_string ace_start">"</span><span class="ace_string">unknown</span><span class="ace_string ace_end">"</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">static</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_trace_ref</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_refcounted</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_OBJECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_object</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">obj</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_object</span> <span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span> <span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">写</span><span class="ace_cjk" style="width:NaNpx">错</span><span class="ace_cjk" style="width:NaNpx">了</span>, rc=%u, <span class="ace_cjk" style="width:NaNpx">应</span><span class="ace_cjk" style="width:NaNpx">为</span>refcount<span class="ace_cjk" style="width:NaNpx">是</span>unsigned int</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">试</span><span class="ace_cjk" style="width:NaNpx">某</span><span class="ace_cjk" style="width:NaNpx">个</span>segment<span class="ace_cjk" style="width:NaNpx">代</span><span class="ace_cjk" style="width:NaNpx">码</span><span class="ace_cjk" style="width:NaNpx">时</span>, <span class="ace_cjk" style="width:NaNpx">发</span><span class="ace_cjk" style="width:NaNpx">现</span> <span class="ace_cjk" style="width:NaNpx">减</span><span class="ace_cjk" style="width:NaNpx">越</span><span class="ace_cjk" style="width:NaNpx">界</span><span class="ace_cjk" style="width:NaNpx">了</span> rc=-1 <span class="ace_cjk" style="width:NaNpx">囧</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_support ace_function ace_C99 ace_c">fprintf</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">stderr</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_string ace_start">"</span><span class="ace_string">[</span><span class="ace_constant ace_language ace_escape">%p</span><span class="ace_string">] rc=</span><span class="ace_constant ace_language ace_escape">%d</span><span class="ace_string"> addr=</span><span class="ace_constant ace_language ace_escape">%d</span><span class="ace_string"> </span><span class="ace_constant ace_language ace_escape">%s</span><span class="ace_string"> object(</span><span class="ace_constant ace_language ace_escape">%s</span><span class="ace_string">)#</span><span class="ace_constant ace_language ace_escape">%d</span><span class="ace_string"> </span><span class="ace_string ace_end">"</span><span class="ace_punctuation ace_operator">,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">GC_ADDRESS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">))</span><span class="ace_punctuation ace_operator">,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_color_name</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REF_GET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">))</span><span class="ace_punctuation ace_operator">,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ce</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">name</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handle</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_ARRAY</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_array</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">arr</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_array</span> <span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span> <span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// rc=%u</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_support ace_function ace_C99 ace_c">fprintf</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">stderr</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_string ace_start">"</span><span class="ace_string">[</span><span class="ace_constant ace_language ace_escape">%p</span><span class="ace_string">] rc=</span><span class="ace_constant ace_language ace_escape">%d</span><span class="ace_string"> addr=</span><span class="ace_constant ace_language ace_escape">%d</span><span class="ace_string"> </span><span class="ace_constant ace_language ace_escape">%s</span><span class="ace_string"> array(</span><span class="ace_constant ace_language ace_escape">%d</span><span class="ace_string">) </span><span class="ace_string ace_end">"</span><span class="ace_punctuation ace_operator">,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">GC_ADDRESS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">))</span><span class="ace_punctuation ace_operator">,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_color_name</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REF_GET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">))</span><span class="ace_punctuation ace_operator">,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_hash_num_elements</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">arr</span><span class="ace_paren ace_rparen">))</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>      <span class="ace_comment">// rc=%u</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_support ace_function ace_C99 ace_c">fprintf</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">stderr</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_string ace_start">"</span><span class="ace_string">[</span><span class="ace_constant ace_language ace_escape">%p</span><span class="ace_string">] rc=</span><span class="ace_constant ace_language ace_escape">%d</span><span class="ace_string"> addr=</span><span class="ace_constant ace_language ace_escape">%d</span><span class="ace_string"> </span><span class="ace_constant ace_language ace_escape">%s</span><span class="ace_string"> </span><span class="ace_constant ace_language ace_escape">%s</span><span class="ace_string"> </span><span class="ace_string ace_end">"</span><span class="ace_punctuation ace_operator">,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">GC_ADDRESS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">))</span><span class="ace_punctuation ace_operator">,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_color_name</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REF_GET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">))</span><span class="ace_punctuation ace_operator">,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_get_type_by_const</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)))</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">将</span> root <span class="ace_cjk" style="width:NaNpx">从</span> Roots buffer <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">从</span>zend_gc_globals.roots <span class="ace_cjk" style="width:NaNpx">转</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">到</span> zend_gc_globals.unused</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">static</span> <span class="ace_identifier">zend_always_inline</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_remove_from_roots</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_root_buffer</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">root</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">将</span> root <span class="ace_cjk" style="width:NaNpx">从</span> roots <span class="ace_cjk" style="width:NaNpx">双</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">root</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">root</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">prev</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">root</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">prev</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">root</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">将</span> root <span class="ace_cjk" style="width:NaNpx">插</span><span class="ace_cjk" style="width:NaNpx">入</span><span class="ace_cjk" style="width:NaNpx">入</span>unused <span class="ace_cjk" style="width:NaNpx">单</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// GC_G(unused) <span class="ace_cjk" style="width:NaNpx">为</span> FILO <span class="ace_cjk" style="width:NaNpx">单</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span>, <span class="ace_cjk" style="width:NaNpx">从</span> prev <span class="ace_cjk" style="width:NaNpx">插</span><span class="ace_cjk" style="width:NaNpx">入</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span>, <span class="ace_cjk" style="width:NaNpx">依</span><span class="ace_cjk" style="width:NaNpx">次</span><span class="ace_cjk" style="width:NaNpx">从</span> prev <span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">root</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">unused</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">unused</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">root</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_BENCH_DEC</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">root_buf_length</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">static</span> <span class="ace_identifier">zend_always_inline</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_remove_from_additional_roots</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_root_buffer</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">root</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">root</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">root</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">prev</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">root</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">prev</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">root</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">除</span> <span class="ace_cjk" style="width:NaNpx">预</span><span class="ace_cjk" style="width:NaNpx">申</span><span class="ace_cjk" style="width:NaNpx">请</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">整</span><span class="ace_cjk" style="width:NaNpx">块</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">放</span> gc_root_buffer <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">连</span><span class="ace_cjk" style="width:NaNpx">续</span><span class="ace_cjk" style="width:NaNpx">空</span><span class="ace_cjk" style="width:NaNpx">间</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">static</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">root_buffer_dtor</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_gc_globals</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">gc_globals</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">buf</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_support ace_function ace_C99 ace_c">free</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">buf</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">buf</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// NTS <span class="ace_cjk" style="width:NaNpx">下</span> gc_globals <span class="ace_cjk" style="width:NaNpx">为</span> <span class="ace_cjk" style="width:NaNpx">全</span><span class="ace_cjk" style="width:NaNpx">局</span> gc <span class="ace_cjk" style="width:NaNpx">变</span><span class="ace_cjk" style="width:NaNpx">量</span> gc_globals</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// TS <span class="ace_cjk" style="width:NaNpx">下</span> <span class="ace_cjk" style="width:NaNpx">每</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">线</span><span class="ace_cjk" style="width:NaNpx">程</span> <span class="ace_cjk" style="width:NaNpx">单</span><span class="ace_cjk" style="width:NaNpx">独</span> gc <span class="ace_cjk" style="width:NaNpx">变</span><span class="ace_cjk" style="width:NaNpx">量</span> gc_globals</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">static</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_globals_ctor_ex</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_gc_globals</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">gc_globals</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">gc_enabled</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">gc_active</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">buf</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// !!!!! gc_globals-&gt;roots <span class="ace_cjk" style="width:NaNpx">本</span><span class="ace_cjk" style="width:NaNpx">身</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">使</span><span class="ace_cjk" style="width:NaNpx">用</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">roots</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">roots</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">roots</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">roots</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">unused</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next_to_free</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">to_free</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">to_free</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">to_free</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">to_free</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">gc_runs</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">collected</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">additional_buffer</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#if</span> <span class="ace_identifier">GC_BENCH</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">root_buf_length</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">root_buf_peak</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">zval_possible_root</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">zval_buffered</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">zval_remove_from_buffer</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">zval_marked_grey</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// gc <span class="ace_cjk" style="width:NaNpx">初</span><span class="ace_cjk" style="width:NaNpx">始</span><span class="ace_cjk" style="width:NaNpx">化</span>2</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_globals_ctor</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#ifdef</span> <span class="ace_identifier">ZTS</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">ts_allocate_id</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">gc_globals_id</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">sizeof</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_gc_globals</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ts_allocate_ctor</span><span class="ace_paren ace_rparen">)</span> <span class="ace_identifier">gc_globals_ctor_ex</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ts_allocate_dtor</span><span class="ace_paren ace_rparen">)</span> <span class="ace_identifier">root_buffer_dtor</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#else</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_globals_ctor_ex</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">gc_globals</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_globals_dtor</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#ifndef</span> <span class="ace_identifier">ZTS</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">root_buffer_dtor</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">gc_globals</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_reset</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_runs</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">collected</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_full</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#if</span> <span class="ace_identifier">GC_BENCH</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">root_buf_length</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">root_buf_peak</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zval_possible_root</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zval_buffered</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zval_remove_from_buffer</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zval_marked_grey</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">区</span><span class="ace_cjk" style="width:NaNpx">分</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">否</span><span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">经</span><span class="ace_cjk" style="width:NaNpx">申</span><span class="ace_cjk" style="width:NaNpx">请</span><span class="ace_cjk" style="width:NaNpx">过</span> buf <span class="ace_cjk" style="width:NaNpx">空</span><span class="ace_cjk" style="width:NaNpx">间</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">buf</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">unused</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">注</span><span class="ace_cjk" style="width:NaNpx">意</span>buf<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">使</span><span class="ace_cjk" style="width:NaNpx">用</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">first_unused</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">buf</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_constant ace_numeric">1</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">unused</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">first_unused</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">last_unused</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">additional_buffer</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// gc <span class="ace_cjk" style="width:NaNpx">初</span><span class="ace_cjk" style="width:NaNpx">始</span><span class="ace_cjk" style="width:NaNpx">化</span>1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_init</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">buf</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_constant ace_language">NULL</span> <span class="ace_keyword ace_operator">&amp;&amp;</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_enabled</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>      <span class="ace_comment">// GC_ROOT_BUFFER_MAX_ENTRIES = 10001, buf[0]<span class="ace_cjk" style="width:NaNpx">保</span><span class="ace_cjk" style="width:NaNpx">留</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">使</span><span class="ace_cjk" style="width:NaNpx">用</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">buf</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_root_buffer</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span> <span class="ace_support ace_function ace_C99 ace_c">malloc</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">sizeof</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_root_buffer</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">*</span> <span class="ace_identifier">GC_ROOT_BUFFER_MAX_ENTRIES</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// &amp;gc_globals.buf[10001]</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">last_unused</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">buf</span><span class="ace_paren ace_rparen">)</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">GC_ROOT_BUFFER_MAX_ENTRIES</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_reset</span><span class="ace_paren ace_lparen">(</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">/*</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"><span class="ace_cjk" style="width:NaNpx">注</span><span class="ace_cjk" style="width:NaNpx">意</span>:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">gc <span class="ace_cjk" style="width:NaNpx">初</span><span class="ace_cjk" style="width:NaNpx">始</span><span class="ace_cjk" style="width:NaNpx">化</span>:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">1. gc_init()  <span class="ace_cjk" style="width:NaNpx">申</span><span class="ace_cjk" style="width:NaNpx">请</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">放</span> gc_root_buffer <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">空</span><span class="ace_cjk" style="width:NaNpx">间</span>, <span class="ace_cjk" style="width:NaNpx">初</span><span class="ace_cjk" style="width:NaNpx">始</span><span class="ace_cjk" style="width:NaNpx">化</span> gc <span class="ace_cjk" style="width:NaNpx">全</span><span class="ace_cjk" style="width:NaNpx">局</span><span class="ace_cjk" style="width:NaNpx">变</span><span class="ace_cjk" style="width:NaNpx">量</span>, <span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">据</span> php.ini <span class="ace_cjk" style="width:NaNpx">决</span><span class="ace_cjk" style="width:NaNpx">定</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">否</span><span class="ace_cjk" style="width:NaNpx">开</span><span class="ace_cjk" style="width:NaNpx">启</span> gc</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">2. gc_globals_dtor()</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">NTS Version</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">$ gdb --args php -v</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">(gdb) b gc_globals_dtor</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">Breakpoint 1 at 0xa5f864: file /data/users/chuxiaofeng/php7/php-7.1.3/Zend/zend_gc.c, line 229.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">(gdb) b gc_init</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">Breakpoint 2 at 0xa5f975: file /data/users/chuxiaofeng/php7/php-7.1.3/Zend/zend_gc.c, line 268.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">(gdb) r</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">(gdb) bt</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">Breakpoint 2, gc_init () at /data/users/chuxiaofeng/php7/php-7.1.3/Zend/zend_gc.c:268</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">268     if (GC_G(buf) == NULL &amp;&amp; GC_G(gc_enabled)) {</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">Missing separate debuginfos, use: debuginfo-install yz-php7-7.1.3-2.el6.x86_64</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">(gdb) bt</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">#0  gc_init () at /data/users/chuxiaofeng/php7/php-7.1.3/Zend/zend_gc.c:268</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">#1  0x0000000000a28448 in OnUpdateGCEnabled (entry=0x14a73f0, new_value=0x149cef0, mh_arg1=0x0,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">    mh_arg2=0x147c760, mh_arg3=0x0, stage=1) at /data/users/chuxiaofeng/php7/php-7.1.3/Zend/zend.c:83</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">#2  0x0000000000a4f324 in zend_register_ini_entries (ini_entry=0x1414430, module_number=0)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">    at /data/users/chuxiaofeng/php7/php-7.1.3/Zend/zend_ini.c:256</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">#3  0x0000000000a298ba in zend_register_standard_ini_entries ()</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">    at /data/users/chuxiaofeng/php7/php-7.1.3/Zend/zend.c:800</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">#4  0x00000000009942f9 in php_module_startup (sf=0x14320e0, additional_modules=0x0,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">    num_additional_modules=0) at /data/users/chuxiaofeng/php7/php-7.1.3/main/main.c:2221</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">#5  0x0000000000b1f63c in php_cli_startup (sapi_module=0x14320e0)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">    at /data/users/chuxiaofeng/php7/php-7.1.3/sapi/cli/php_cli.c:427</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">#6  0x0000000000b21658 in main (argc=2, argv=0x1480d80)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">    at /data/users/chuxiaofeng/php7/php-7.1.3/sapi/cli/php_cli.c:1348</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">(gdb) c</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">(gdb) bt</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">Breakpoint 1, gc_globals_dtor () at /data/users/chuxiaofeng/php7/php-7.1.3/Zend/zend_gc.c:229</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">229     root_buffer_dtor(&amp;gc_globals);</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">(gdb) bt</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">#0  gc_globals_dtor () at /data/users/chuxiaofeng/php7/php-7.1.3/Zend/zend_gc.c:229</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">#1  0x0000000000994840 in php_module_shutdown ()</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">    at /data/users/chuxiaofeng/php7/php-7.1.3/main/main.c:2428</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">#2  0x0000000000b21767 in main (argc=2, argv=0x1480d80)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">    at /data/users/chuxiaofeng/php7/php-7.1.3/sapi/cli/php_cli.c:1396</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">*/</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">/*</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * unset <span class="ace_cjk" style="width:NaNpx">、</span><span class="ace_cjk" style="width:NaNpx">变</span><span class="ace_cjk" style="width:NaNpx">量</span><span class="ace_cjk" style="width:NaNpx">重</span><span class="ace_cjk" style="width:NaNpx">新</span><span class="ace_cjk" style="width:NaNpx">赋</span><span class="ace_cjk" style="width:NaNpx">值</span><span class="ace_cjk" style="width:NaNpx">、</span>return <span class="ace_cjk" style="width:NaNpx">等</span><span class="ace_cjk" style="width:NaNpx">操</span><span class="ace_cjk" style="width:NaNpx">作</span><span class="ace_cjk" style="width:NaNpx">都</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">将</span> ref <span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span><span class="ace_cjk" style="width:NaNpx">到</span> Roots buffer (<span class="ace_cjk" style="width:NaNpx">即</span> roots <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span>)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * <span class="ace_cjk" style="width:NaNpx">配</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">的</span>zval<span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">型</span><span class="ace_cjk" style="width:NaNpx">的</span>zend_value<span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">部</span><span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">域</span><span class="ace_cjk" style="width:NaNpx">都</span><span class="ace_cjk" style="width:NaNpx">是</span>zend_ref_counted_h</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * <span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">以</span>zend_refcounted*<span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">与</span>zend_array* zend_object*<span class="ace_cjk" style="width:NaNpx">相</span><span class="ace_cjk" style="width:NaNpx">互</span><span class="ace_cjk" style="width:NaNpx">转</span><span class="ace_cjk" style="width:NaNpx">换</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * A node MAY be added to possbile roots when ZEND_UNSET_VAR happens or</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * zend_assign_to_variable is called only when possible garbage node is</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * produced.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * gc_possible_root() will be called to add the nodes to possible roots.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * gc <span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span> BLACK -&gt; PURPLE</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">ZEND_FASTCALL</span> <span class="ace_identifier">gc_possible_root</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_refcounted</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_root_buffer</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">newRoot</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// _zend_bailout <span class="ace_cjk" style="width:NaNpx">之</span><span class="ace_cjk" style="width:NaNpx">后</span>unclean_shutdown=1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// zend<span class="ace_cjk" style="width:NaNpx">出</span><span class="ace_cjk" style="width:NaNpx">错</span><span class="ace_cjk" style="width:NaNpx">准</span><span class="ace_cjk" style="width:NaNpx">备</span><span class="ace_cjk" style="width:NaNpx">退</span><span class="ace_cjk" style="width:NaNpx">出</span><span class="ace_cjk" style="width:NaNpx">或</span><span class="ace_cjk" style="width:NaNpx">者</span><span class="ace_cjk" style="width:NaNpx">关</span><span class="ace_cjk" style="width:NaNpx">闭</span><span class="ace_cjk" style="width:NaNpx">了</span>gc<span class="ace_cjk" style="width:NaNpx">情</span><span class="ace_cjk" style="width:NaNpx">况</span><span class="ace_cjk" style="width:NaNpx">下</span><span class="ace_cjk" style="width:NaNpx">直</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">返</span><span class="ace_cjk" style="width:NaNpx">回</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">UNEXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">CG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">unclean_shutdown</span><span class="ace_paren ace_rparen">))</span> <span class="ace_keyword ace_operator">||</span> <span class="ace_identifier">UNEXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_active</span><span class="ace_paren ace_rparen">)))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">只</span><span class="ace_cjk" style="width:NaNpx">有</span>array<span class="ace_cjk" style="width:NaNpx">与</span>object<span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">型</span><span class="ace_cjk" style="width:NaNpx">参</span><span class="ace_cjk" style="width:NaNpx">与</span>gc</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">ZEND_ASSERT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_ARRAY</span> <span class="ace_keyword ace_operator">||</span> <span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_OBJECT</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// black <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">两</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span>bit<span class="ace_cjk" style="width:NaNpx">位</span><span class="ace_cjk" style="width:NaNpx">为</span>0, <span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span>gc<span class="ace_cjk" style="width:NaNpx">待</span><span class="ace_cjk" style="width:NaNpx">检</span><span class="ace_cjk" style="width:NaNpx">测</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">前</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">应</span><span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">信</span><span class="ace_cjk" style="width:NaNpx">息</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">ZEND_ASSERT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REF_GET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">GC_BLACK</span><span class="ace_paren ace_rparen">))</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">同</span><span class="ace_cjk" style="width:NaNpx">样</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">应</span><span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">信</span><span class="ace_cjk" style="width:NaNpx">息</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">ZEND_ASSERT</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">GC_ADDRESS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)))</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_BENCH_INC</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zval_possible_root</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">注</span><span class="ace_cjk" style="width:NaNpx">意</span>: unused <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">连</span><span class="ace_cjk" style="width:NaNpx">续</span>, Root buffer <span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">连</span><span class="ace_cjk" style="width:NaNpx">续</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">//       <span class="ace_cjk" style="width:NaNpx">从</span> Root buffer <span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">挂</span><span class="ace_cjk" style="width:NaNpx">到</span> unused <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">//       <span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span> gc_root_buffer <span class="ace_cjk" style="width:NaNpx">优</span><span class="ace_cjk" style="width:NaNpx">先</span><span class="ace_cjk" style="width:NaNpx">从</span> unused <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span>, <span class="ace_cjk" style="width:NaNpx">其</span><span class="ace_cjk" style="width:NaNpx">次</span><span class="ace_cjk" style="width:NaNpx">从</span> Root buffer <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">newRoot</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">unused</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">newRoot</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>      <span class="ace_comment">// unused<span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">用</span>gc_root_buffer, <span class="ace_cjk" style="width:NaNpx">优</span><span class="ace_cjk" style="width:NaNpx">先</span><span class="ace_cjk" style="width:NaNpx">从</span>unused<span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">unused</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">newRoot</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">prev</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">first_unused</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">last_unused</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>      <span class="ace_comment">// unused<span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">无</span> gc_root_buffer, Root buffer <span class="ace_cjk" style="width:NaNpx">未</span><span class="ace_cjk" style="width:NaNpx">满</span>, <span class="ace_cjk" style="width:NaNpx">从</span>buf<span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span>, <span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">针</span><span class="ace_cjk" style="width:NaNpx">前</span><span class="ace_cjk" style="width:NaNpx">移</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">newRoot</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">first_unused</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">first_unused</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">到</span>gc_root_buffer<span class="ace_cjk" style="width:NaNpx">时</span>, <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span>gc<span class="ace_cjk" style="width:NaNpx">关</span><span class="ace_cjk" style="width:NaNpx">闭</span><span class="ace_cjk" style="width:NaNpx">直</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">返</span><span class="ace_cjk" style="width:NaNpx">回</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">否</span><span class="ace_cjk" style="width:NaNpx">则</span><span class="ace_cjk" style="width:NaNpx">先</span><span class="ace_cjk" style="width:NaNpx">进</span><span class="ace_cjk" style="width:NaNpx">行</span>gc<span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">次</span>gc</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_enabled</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// ?? ++ <span class="ace_cjk" style="width:NaNpx">原</span><span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">了</span><span class="ace_cjk" style="width:NaNpx">防</span><span class="ace_cjk" style="width:NaNpx">止</span>gc<span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">程</span><span class="ace_cjk" style="width:NaNpx">将</span>ref<span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_collect_cycles</span><span class="ace_paren ace_lparen">(</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">--</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// gc<span class="ace_cjk" style="width:NaNpx">完</span><span class="ace_cjk" style="width:NaNpx">成</span>, <span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">将</span><span class="ace_cjk" style="width:NaNpx">致</span><span class="ace_cjk" style="width:NaNpx">使</span>ref<span class="ace_cjk" style="width:NaNpx">的</span>refcount&gt;0<span class="ace_cjk" style="width:NaNpx">的</span>ref<span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span>,ref<span class="ace_cjk" style="width:NaNpx">的</span>refcount<span class="ace_cjk" style="width:NaNpx">减</span><span class="ace_cjk" style="width:NaNpx">为</span>0, <span class="ace_cjk" style="width:NaNpx">直</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">UNEXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">))</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zval_dtor_func</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">有</span> gc_info <span class="ace_cjk" style="width:NaNpx">说</span><span class="ace_cjk" style="width:NaNpx">明</span><span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">成</span><span class="ace_cjk" style="width:NaNpx">非</span> black, <span class="ace_cjk" style="width:NaNpx">或</span><span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">经</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span> Root buffer</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">既</span><span class="ace_cjk" style="width:NaNpx">然</span><span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">经</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span><span class="ace_cjk" style="width:NaNpx">直</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">返</span><span class="ace_cjk" style="width:NaNpx">回</span>, ?? <span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// gc <span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">程</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">执</span><span class="ace_cjk" style="width:NaNpx">行</span> zval_dtor, <span class="ace_cjk" style="width:NaNpx">比</span><span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">析</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span>, <span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">在</span> gc <span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">程</span><span class="ace_cjk" style="width:NaNpx">将</span><span class="ace_cjk" style="width:NaNpx">新</span><span class="ace_cjk" style="width:NaNpx">的</span> gc_root_buffer <span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span> Root buffer </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">比</span><span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">析</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">造</span><span class="ace_cjk" style="width:NaNpx">成</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">循</span><span class="ace_cjk" style="width:NaNpx">环</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span>, TODO: example</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">UNEXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// gc<span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">后</span>, <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">回</span><span class="ace_cjk" style="width:NaNpx">收</span>, unused<span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">应</span><span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">经</span><span class="ace_cjk" style="width:NaNpx">插</span><span class="ace_cjk" style="width:NaNpx">入</span> gc_root_buffer</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">从</span> unused <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span> gc_root_buffer, <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">有</span>, <span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span><span class="ace_cjk" style="width:NaNpx">到</span> roots <span class="ace_cjk" style="width:NaNpx">中</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">仍</span><span class="ace_cjk" style="width:NaNpx">旧</span><span class="ace_cjk" style="width:NaNpx">没</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">空</span><span class="ace_cjk" style="width:NaNpx">间</span>, <span class="ace_cjk" style="width:NaNpx">产</span><span class="ace_cjk" style="width:NaNpx">生</span><span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">泄</span><span class="ace_cjk" style="width:NaNpx">漏</span> !!</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// zend_refcounted   refount &gt; 0 gc_info = 0</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">newRoot</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">unused</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">newRoot</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#if</span> <span class="ace_identifier">ZEND_GC_DEBUG</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_full</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_support ace_function ace_C99 ace_c">fprintf</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">stderr</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_string ace_start">"</span><span class="ace_string">GC: no space to record new root candidate</span><span class="ace_constant ace_language ace_escape">\n</span><span class="ace_string ace_end">"</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_full</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">1</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">unused</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">newRoot</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">prev</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span>GC_G(roots)<span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">将</span><span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">变</span><span class="ace_cjk" style="width:NaNpx">为</span>GC_PURPLE, <span class="ace_cjk" style="width:NaNpx">防</span><span class="ace_cjk" style="width:NaNpx">止</span><span class="ace_cjk" style="width:NaNpx">重</span><span class="ace_cjk" style="width:NaNpx">复</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_TRACE_SET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">GC_PURPLE</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// gc_info <span class="ace_cjk" style="width:NaNpx">由</span>buf<span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">地</span><span class="ace_cjk" style="width:NaNpx">址</span><span class="ace_cjk" style="width:NaNpx">和</span><span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">共</span><span class="ace_cjk" style="width:NaNpx">同</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">成</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">newRoot</span> <span class="ace_keyword ace_operator">-</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">buf</span><span class="ace_paren ace_rparen">))</span> <span class="ace_keyword ace_operator">|</span> <span class="ace_identifier">GC_PURPLE</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">newRoot</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span>GC_G(roots)<span class="ace_cjk" style="width:NaNpx">双</span><span class="ace_cjk" style="width:NaNpx">向</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">newRoot</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">newRoot</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">newRoot</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">newRoot</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_BENCH_INC</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zval_buffered</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_BENCH_INC</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">root_buf_length</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_BENCH_PEAK</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">root_buf_peak</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">root_buf_length</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">在</span> additional_buffer <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">中</span> <span class="ace_cjk" style="width:NaNpx">寻</span><span class="ace_cjk" style="width:NaNpx">找</span> zend_refcounted <span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">的</span> gc_root_buffer</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">static</span> <span class="ace_identifier">zend_always_inline</span> <span class="ace_identifier">gc_root_buffer</span><span class="ace_keyword ace_operator">*</span> <span class="ace_identifier">gc_find_additional_buffer</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_refcounted</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_additional_buffer</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">additional_buffer</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">additional_buffer</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">/* We have to check each additional_buffer to find which one holds the ref */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">additional_buffer</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">注</span><span class="ace_cjk" style="width:NaNpx">意</span>: additional_buffer <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">的</span> ref gc_info <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">地</span><span class="ace_cjk" style="width:NaNpx">址</span> <span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">都</span>+10001, <span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">区</span><span class="ace_cjk" style="width:NaNpx">分</span>, <span class="ace_cjk" style="width:NaNpx">真</span><span class="ace_cjk" style="width:NaNpx">实</span><span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">要</span> -10001</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">uint32_t</span> <span class="ace_identifier">idx</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_ADDRESS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">))</span> <span class="ace_keyword ace_operator">-</span> <span class="ace_identifier">GC_ROOT_BUFFER_MAX_ENTRIES</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span> index <span class="ace_cjk" style="width:NaNpx">大</span><span class="ace_cjk" style="width:NaNpx">于</span><span class="ace_cjk" style="width:NaNpx">等</span><span class="ace_cjk" style="width:NaNpx">于</span><span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">前</span>used, <span class="ace_cjk" style="width:NaNpx">说</span><span class="ace_cjk" style="width:NaNpx">明</span>ref<span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">定</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">前</span> additional_buffer <span class="ace_cjk" style="width:NaNpx">中</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">idx</span> <span class="ace_keyword ace_operator">&lt;</span> <span class="ace_identifier">additional_buffer</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">used</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_root_buffer</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">root</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">additional_buffer</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">buf</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">idx</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">root</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span> <span class="ace_identifier">root</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">additional_buffer</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">additional_buffer</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">ZEND_ASSERT</span><span class="ace_paren ace_lparen">(</span><span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">return</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">将</span> ref <span class="ace_cjk" style="width:NaNpx">从</span> Roots buffer <span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span> <span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">除</span> gc_info</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// gc_remove_nested_data_from_buffer <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">ZEND_FASTCALL</span> <span class="ace_identifier">gc_remove_from_buffer</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_refcounted</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_root_buffer</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">root</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">断</span><span class="ace_cjk" style="width:NaNpx">言</span> ref <span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">定</span><span class="ace_cjk" style="width:NaNpx">在</span> Root buffer (<span class="ace_cjk" style="width:NaNpx">包</span><span class="ace_cjk" style="width:NaNpx">括</span> additional buffer)<span class="ace_cjk" style="width:NaNpx">中</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">ZEND_ASSERT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_ADDRESS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)))</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_BENCH_INC</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zval_remove_from_buffer</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">据</span><span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">判</span><span class="ace_cjk" style="width:NaNpx">断</span><span class="ace_cjk" style="width:NaNpx">该</span>ref<span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">哪</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">中</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_ADDRESS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">))</span> <span class="ace_keyword ace_operator">&lt;</span> <span class="ace_identifier">GC_ROOT_BUFFER_MAX_ENTRIES</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">据</span><span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">算</span><span class="ace_cjk" style="width:NaNpx">真</span><span class="ace_cjk" style="width:NaNpx">实</span><span class="ace_cjk" style="width:NaNpx">地</span><span class="ace_cjk" style="width:NaNpx">址</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">root</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">buf</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">GC_ADDRESS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">))</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_remove_from_roots</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">root</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">root</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">gc_find_additional_buffer</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_remove_from_additional_roots</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">root</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// ?? != GC_BLACK <span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">示</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REF_GET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">GC_BLACK</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_TRACE_SET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">GC_PURPLE</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span><span class="ace_cjk" style="width:NaNpx">之</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">除</span>gc<span class="ace_cjk" style="width:NaNpx">信</span><span class="ace_cjk" style="width:NaNpx">息</span>: <span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">数</span>+<span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span>, <span class="ace_cjk" style="width:NaNpx">即</span><span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">数</span>=0, <span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span>= black</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span> GC_G(next_to_free) <span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">经</span><span class="ace_cjk" style="width:NaNpx">从</span> Roots buffer <span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span>, <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">直</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">跳</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">下</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span>~</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">/* updete next root that is going to be freed */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">next_to_free</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">root</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">next_to_free</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">root</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// gc <span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">二</span><span class="ace_cjk" style="width:NaNpx">阶</span><span class="ace_cjk" style="width:NaNpx">段</span><span class="ace_cjk" style="width:NaNpx">发</span><span class="ace_cjk" style="width:NaNpx">现</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span> &gt;0, <span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">明</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span>, <span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span> black, </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">阶</span><span class="ace_cjk" style="width:NaNpx">段</span><span class="ace_cjk" style="width:NaNpx">减</span>1<span class="ace_cjk" style="width:NaNpx">了</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span>, <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">同</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">加</span>1<span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">恢</span><span class="ace_cjk" style="width:NaNpx">复</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">static</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_scan_black</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_refcounted</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">HashTable</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ht</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">Bucket</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">p</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">end</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">zval</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zv</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// ref <span class="ace_cjk" style="width:NaNpx">同</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">也</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">尾</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">参</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// gc <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">的</span>scan <span class="ace_cjk" style="width:NaNpx">基</span><span class="ace_cjk" style="width:NaNpx">本</span><span class="ace_cjk" style="width:NaNpx">都</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">的</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">用</span>goto<span class="ace_cjk" style="width:NaNpx">尽</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">人</span><span class="ace_cjk" style="width:NaNpx">肉</span><span class="ace_cjk" style="width:NaNpx">展</span><span class="ace_cjk" style="width:NaNpx">开</span>, <span class="ace_cjk" style="width:NaNpx">通</span><span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">尾</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">消</span><span class="ace_cjk" style="width:NaNpx">除</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">消</span><span class="ace_cjk" style="width:NaNpx">除</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span>, <span class="ace_cjk" style="width:NaNpx">常</span><span class="ace_cjk" style="width:NaNpx">量</span><span class="ace_cjk" style="width:NaNpx">栈</span><span class="ace_cjk" style="width:NaNpx">消</span><span class="ace_cjk" style="width:NaNpx">耗</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">ht</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// refcount &gt; 0 , <span class="ace_cjk" style="width:NaNpx">非</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_REF_SET_BLACK</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_OBJECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">普</span><span class="ace_cjk" style="width:NaNpx">通</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">都</span><span class="ace_cjk" style="width:NaNpx">是</span> zend_std_get_gc, <span class="ace_cjk" style="width:NaNpx">在</span>zend_object_handlers.c<span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">定</span><span class="ace_cjk" style="width:NaNpx">义</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">某</span><span class="ace_cjk" style="width:NaNpx">些</span> c <span class="ace_cjk" style="width:NaNpx">实</span><span class="ace_cjk" style="width:NaNpx">现</span><span class="ace_cjk" style="width:NaNpx">的</span> php<span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">重</span><span class="ace_cjk" style="width:NaNpx">写</span><span class="ace_cjk" style="width:NaNpx">此</span><span class="ace_cjk" style="width:NaNpx">方</span><span class="ace_cjk" style="width:NaNpx">法</span>, <span class="ace_cjk" style="width:NaNpx">比</span><span class="ace_cjk" style="width:NaNpx">如</span>zend_generator</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_object_get_gc_t</span> <span class="ace_identifier">get_gc</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_object</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">obj</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_object</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ZEND_ASSERT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">objects_store</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">object_buckets</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_FLAGS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">&amp;</span> <span class="ace_identifier">IS_OBJ_FREE_CALLED</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span> <span class="ace_identifier">IS_OBJ_VALID</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">objects_store</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">object_buckets</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handle</span><span class="ace_paren ace_rparen">])</span> <span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">get_gc</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handlers</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">get_gc</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_storage ace_type">int</span> <span class="ace_identifier">n</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zval</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zv</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">end</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zval</span> <span class="ace_identifier">tmp</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// zv: zval** <span class="ace_cjk" style="width:NaNpx">开</span><span class="ace_cjk" style="width:NaNpx">始</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// zv: zval** <span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">量</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ZVAL_OBJ</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">tmp</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ht</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">get_gc</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">tmp</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">zv</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">n</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">end</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">n</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">分</span><span class="ace_cjk" style="width:NaNpx">支</span><span class="ace_cjk" style="width:NaNpx">说</span><span class="ace_cjk" style="width:NaNpx">明</span><span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">实</span><span class="ace_cjk" style="width:NaNpx">例</span><span class="ace_cjk" style="width:NaNpx">只</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">显</span><span class="ace_cjk" style="width:NaNpx">示</span><span class="ace_cjk" style="width:NaNpx">声</span><span class="ace_cjk" style="width:NaNpx">明</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span>, <span class="ace_cjk" style="width:NaNpx">无</span><span class="ace_cjk" style="width:NaNpx">运</span><span class="ace_cjk" style="width:NaNpx">行</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">动</span><span class="ace_cjk" style="width:NaNpx">态</span><span class="ace_cjk" style="width:NaNpx">添</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">ht</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">n</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">逆</span><span class="ace_cjk" style="width:NaNpx">向</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span><span class="ace_cjk" style="width:NaNpx">表</span>, <span class="ace_cjk" style="width:NaNpx">查</span><span class="ace_cjk" style="width:NaNpx">看</span><span class="ace_cjk" style="width:NaNpx">找</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">带</span><span class="ace_cjk" style="width:NaNpx">有</span>refcount<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">--</span><span class="ace_identifier">end</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// ref <span class="ace_cjk" style="width:NaNpx">无</span><span class="ace_cjk" style="width:NaNpx">子</span>ref<span class="ace_cjk" style="width:NaNpx">需</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">处</span><span class="ace_cjk" style="width:NaNpx">理</span>, <span class="ace_cjk" style="width:NaNpx">直</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">返</span><span class="ace_cjk" style="width:NaNpx">回</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">正</span><span class="ace_cjk" style="width:NaNpx">向</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span>ref<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span>, <span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">没</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span><span class="ace_cjk" style="width:NaNpx">到</span>end, <span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">扫</span><span class="ace_cjk" style="width:NaNpx">描</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">在</span>gc_mark_grey <span class="ace_cjk" style="width:NaNpx">减</span>1<span class="ace_cjk" style="width:NaNpx">了</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span>, <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">回</span><span class="ace_cjk" style="width:NaNpx">去</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// ?? <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">只</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">是</span>BLACK, <span class="ace_cjk" style="width:NaNpx">都</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span>, <span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">扫</span><span class="ace_cjk" style="width:NaNpx">描</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REF_GET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">GC_BLACK</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_scan_black</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">此</span><span class="ace_cjk" style="width:NaNpx">时</span>zv == end</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">尾</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">扫</span><span class="ace_cjk" style="width:NaNpx">描</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span>ref<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">分</span><span class="ace_cjk" style="width:NaNpx">支</span><span class="ace_cjk" style="width:NaNpx">说</span><span class="ace_cjk" style="width:NaNpx">明</span><span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">实</span><span class="ace_cjk" style="width:NaNpx">例</span><span class="ace_cjk" style="width:NaNpx">只</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">显</span><span class="ace_cjk" style="width:NaNpx">示</span><span class="ace_cjk" style="width:NaNpx">声</span><span class="ace_cjk" style="width:NaNpx">明</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span>, <span class="ace_cjk" style="width:NaNpx">无</span><span class="ace_cjk" style="width:NaNpx">运</span><span class="ace_cjk" style="width:NaNpx">行</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">动</span><span class="ace_cjk" style="width:NaNpx">态</span><span class="ace_cjk" style="width:NaNpx">添</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">有</span>ht<span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">间</span>, zv <span class="ace_cjk" style="width:NaNpx">恒</span><span class="ace_cjk" style="width:NaNpx">等</span><span class="ace_cjk" style="width:NaNpx">于</span> end, zv == NULL, <span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">以</span> !ht</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// while <span class="ace_cjk" style="width:NaNpx">循</span><span class="ace_cjk" style="width:NaNpx">环</span><span class="ace_cjk" style="width:NaNpx">无</span><span class="ace_cjk" style="width:NaNpx">法</span><span class="ace_cjk" style="width:NaNpx">使</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">尾</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">代</span><span class="ace_cjk" style="width:NaNpx">替</span><span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span>, <span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">使</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">尾</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">代</span><span class="ace_cjk" style="width:NaNpx">替</span><span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">省</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">次</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">ht</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">在</span>gc_mark_grey <span class="ace_cjk" style="width:NaNpx">减</span>1<span class="ace_cjk" style="width:NaNpx">了</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span>, <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">回</span><span class="ace_cjk" style="width:NaNpx">去</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REF_GET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">GC_BLACK</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">goto</span> <span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_ARRAY</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">((</span><span class="ace_identifier">zend_array</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">symbol_table</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ht</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_array</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_REFERENCE</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">向</span><span class="ace_cjk" style="width:NaNpx">的</span>zval<span class="ace_cjk" style="width:NaNpx">无</span>ref<span class="ace_cjk" style="width:NaNpx">直</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">返</span><span class="ace_cjk" style="width:NaNpx">回</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED</span><span class="ace_paren ace_lparen">(((</span><span class="ace_identifier">zend_reference</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED</span><span class="ace_paren ace_lparen">(((</span><span class="ace_identifier">zend_reference</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">在</span>gc_mark_grey <span class="ace_cjk" style="width:NaNpx">减</span>1<span class="ace_cjk" style="width:NaNpx">了</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span>, <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">恢</span><span class="ace_cjk" style="width:NaNpx">复</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REF_GET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">GC_BLACK</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">goto</span> <span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">ht</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">nNumUsed</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">ht</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">arData</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">end</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">ht</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">nNumUsed</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">逆</span><span class="ace_cjk" style="width:NaNpx">向</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_constant ace_numeric">1</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">end</span><span class="ace_keyword ace_operator">--</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">end</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">直</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">变</span><span class="ace_cjk" style="width:NaNpx">量</span><span class="ace_cjk" style="width:NaNpx">则</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span>zv, <span class="ace_cjk" style="width:NaNpx">比</span><span class="ace_cjk" style="width:NaNpx">如</span>zend_property_info</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_INDIRECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_INDIRECT_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">发</span><span class="ace_cjk" style="width:NaNpx">现</span>ht<span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span>ref<span class="ace_cjk" style="width:NaNpx">的</span>zv, <span class="ace_cjk" style="width:NaNpx">停</span><span class="ace_cjk" style="width:NaNpx">止</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">break</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">整</span><span class="ace_cjk" style="width:NaNpx">个</span>ht<span class="ace_cjk" style="width:NaNpx">没</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span>ref<span class="ace_cjk" style="width:NaNpx">的</span>zv<span class="ace_cjk" style="width:NaNpx">直</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">返</span><span class="ace_cjk" style="width:NaNpx">回</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// end <span class="ace_cjk" style="width:NaNpx">此</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span>ref<span class="ace_cjk" style="width:NaNpx">的</span>zval</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">正</span><span class="ace_cjk" style="width:NaNpx">向</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span>ref<span class="ace_cjk" style="width:NaNpx">的</span>zval, <span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">扫</span><span class="ace_cjk" style="width:NaNpx">描</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">p</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_INDIRECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_INDIRECT_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REF_GET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">GC_BLACK</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_scan_black</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">p</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">p</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_INDIRECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_INDIRECT_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REF_GET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">GC_BLACK</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">goto</span> <span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">深</span><span class="ace_cjk" style="width:NaNpx">度</span><span class="ace_cjk" style="width:NaNpx">优</span><span class="ace_cjk" style="width:NaNpx">先</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span>grey</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">static</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_mark_grey</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_refcounted</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_identifier">HashTable</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ht</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">Bucket</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">p</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">end</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">zval</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zv</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// ref <span class="ace_cjk" style="width:NaNpx">同</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">也</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">尾</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">参</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">深</span><span class="ace_cjk" style="width:NaNpx">度</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span>&gt;1<span class="ace_cjk" style="width:NaNpx">次</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">同</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span>ref, <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">做</span><span class="ace_cjk" style="width:NaNpx">下</span><span class="ace_cjk" style="width:NaNpx">判</span><span class="ace_cjk" style="width:NaNpx">断</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REF_GET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">GC_GREY</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ht</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_BENCH_INC</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zval_marked_grey</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">本</span><span class="ace_cjk" style="width:NaNpx">次</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">的</span>root ref<span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span>grey</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REF_SET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">GC_GREY</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">同</span><span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">型</span>ref<span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">分</span><span class="ace_cjk" style="width:NaNpx">开</span><span class="ace_cjk" style="width:NaNpx">处</span><span class="ace_cjk" style="width:NaNpx">理</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_OBJECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">普</span><span class="ace_cjk" style="width:NaNpx">通</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">都</span><span class="ace_cjk" style="width:NaNpx">是</span> zend_std_get_gc, <span class="ace_cjk" style="width:NaNpx">在</span>zend_object_handlers.c<span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">定</span><span class="ace_cjk" style="width:NaNpx">义</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">某</span><span class="ace_cjk" style="width:NaNpx">些</span>php<span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">在</span>c<span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">重</span><span class="ace_cjk" style="width:NaNpx">写</span><span class="ace_cjk" style="width:NaNpx">此</span><span class="ace_cjk" style="width:NaNpx">方</span><span class="ace_cjk" style="width:NaNpx">法</span>, <span class="ace_cjk" style="width:NaNpx">比</span><span class="ace_cjk" style="width:NaNpx">如</span>zend_generator</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_object_get_gc_t</span> <span class="ace_identifier">get_gc</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_object</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">obj</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_object</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">下</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">优</span><span class="ace_cjk" style="width:NaNpx">化</span>, <span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">只</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span><span class="ace_cjk" style="width:NaNpx">需</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">处</span><span class="ace_cjk" style="width:NaNpx">理</span><span class="ace_cjk" style="width:NaNpx">时</span>, <span class="ace_cjk" style="width:NaNpx">采</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">尾</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">方</span><span class="ace_cjk" style="width:NaNpx">式</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">有</span>n(n&gt;1)<span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span><span class="ace_cjk" style="width:NaNpx">需</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">处</span><span class="ace_cjk" style="width:NaNpx">理</span><span class="ace_cjk" style="width:NaNpx">时</span>, <span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">迭</span><span class="ace_cjk" style="width:NaNpx">代</span><span class="ace_cjk" style="width:NaNpx">方</span><span class="ace_cjk" style="width:NaNpx">式</span><span class="ace_cjk" style="width:NaNpx">处</span><span class="ace_cjk" style="width:NaNpx">理</span>n-1<span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span>, <span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">尾</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">方</span><span class="ace_cjk" style="width:NaNpx">式</span><span class="ace_cjk" style="width:NaNpx">处</span><span class="ace_cjk" style="width:NaNpx">理</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">省</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span>, <span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">省</span><span class="ace_cjk" style="width:NaNpx">栈</span><span class="ace_cjk" style="width:NaNpx">开</span><span class="ace_cjk" style="width:NaNpx">销</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">擎</span><span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">全</span><span class="ace_cjk" style="width:NaNpx">部</span><span class="ace_cjk" style="width:NaNpx">都</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">都</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">以</span>handle<span class="ace_cjk" style="width:NaNpx">作</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">下</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">保</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">在</span> EG(objects_store).object_buckets[obj-&gt;handle]</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ZEND_ASSERT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">objects_store</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">object_buckets</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// Zend/zend_objects_API.c :: zend_objects_store_free_object_storage </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// GC_FLAGS(obj) |= IS_OBJ_FREE_CALLED; <span class="ace_cjk" style="width:NaNpx">然</span><span class="ace_cjk" style="width:NaNpx">后</span> obj-&gt;handlers-&gt;free_obj(obj)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_FLAGS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">&amp;</span> <span class="ace_identifier">IS_OBJ_FREE_CALLED</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>                 <span class="ace_identifier">IS_OBJ_VALID</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">objects_store</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">object_buckets</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handle</span><span class="ace_paren ace_rparen">])</span> <span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>                     <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">get_gc</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handlers</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">get_gc</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_storage ace_type">int</span> <span class="ace_identifier">n</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zval</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zv</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">end</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zval</span> <span class="ace_identifier">tmp</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ZVAL_OBJ</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">tmp</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ht</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">get_gc</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">tmp</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">zv</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">n</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">end</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">n</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">ht</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span><span class="ace_cjk" style="width:NaNpx">全</span><span class="ace_cjk" style="width:NaNpx">部</span><span class="ace_cjk" style="width:NaNpx">显</span><span class="ace_cjk" style="width:NaNpx">式</span><span class="ace_cjk" style="width:NaNpx">声</span><span class="ace_cjk" style="width:NaNpx">明</span>, <span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">量</span><span class="ace_cjk" style="width:NaNpx">未</span>n</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">n</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">逆</span><span class="ace_cjk" style="width:NaNpx">向</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span>, <span class="ace_cjk" style="width:NaNpx">找</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span>ref<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span>: end</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">--</span><span class="ace_identifier">end</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">全</span><span class="ace_cjk" style="width:NaNpx">部</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span><span class="ace_cjk" style="width:NaNpx">都</span><span class="ace_cjk" style="width:NaNpx">无</span>ref, <span class="ace_cjk" style="width:NaNpx">直</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">返</span><span class="ace_cjk" style="width:NaNpx">回</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">从</span>zv<span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span>ref<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span>, <span class="ace_cjk" style="width:NaNpx">正</span><span class="ace_cjk" style="width:NaNpx">向</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span>(<span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">包</span><span class="ace_cjk" style="width:NaNpx">括</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span>ref<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span>end)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">肯</span><span class="ace_cjk" style="width:NaNpx">定</span><span class="ace_cjk" style="width:NaNpx">也</span><span class="ace_cjk" style="width:NaNpx">是</span> !ht, <span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">有</span> ht <span class="ace_cjk" style="width:NaNpx">时</span>, zv = NULL, n = 0, end = 0</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">找</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span>ref<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span>, <span class="ace_cjk" style="width:NaNpx">减</span>1<span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span>, <span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span>sub graph</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">--</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_mark_grey</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">ht</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span> <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">有</span>ht<span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">，</span>zv<span class="ace_cjk" style="width:NaNpx">为</span>NULL</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">此</span><span class="ace_cjk" style="width:NaNpx">时</span>zv==end, <span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">采</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">尾</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">方</span><span class="ace_cjk" style="width:NaNpx">式</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">逆</span><span class="ace_cjk" style="width:NaNpx">序</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span><span class="ace_cjk" style="width:NaNpx">找</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span>ref<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span><span class="ace_cjk" style="width:NaNpx">减</span>1<span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span>grey</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">--</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">goto</span> <span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_ARRAY</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(((</span><span class="ace_identifier">zend_array</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">symbol_table</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REF_SET_BLACK</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ht</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_array</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_REFERENCE</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">型</span><span class="ace_cjk" style="width:NaNpx">时</span>, <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span> ref <span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">向</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span><span class="ace_cjk" style="width:NaNpx">是</span>zend_array <span class="ace_cjk" style="width:NaNpx">或</span><span class="ace_cjk" style="width:NaNpx">者</span> zend_object(<span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span>gc <span class="ace_cjk" style="width:NaNpx">结</span><span class="ace_cjk" style="width:NaNpx">构</span>)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">只</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span>, <span class="ace_cjk" style="width:NaNpx">原</span><span class="ace_cjk" style="width:NaNpx">地</span><span class="ace_cjk" style="width:NaNpx">减</span>1<span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span>, <span class="ace_cjk" style="width:NaNpx">尾</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span> sub graph</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED</span><span class="ace_paren ace_lparen">(((</span><span class="ace_identifier">zend_reference</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED</span><span class="ace_paren ace_lparen">(((</span><span class="ace_identifier">zend_reference</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">--</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">goto</span> <span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">下</span><span class="ace_cjk" style="width:NaNpx">代</span><span class="ace_cjk" style="width:NaNpx">码</span><span class="ace_cjk" style="width:NaNpx">主</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">处</span><span class="ace_cjk" style="width:NaNpx">理</span><span class="ace_cjk" style="width:NaNpx">两</span><span class="ace_cjk" style="width:NaNpx">种</span><span class="ace_cjk" style="width:NaNpx">情</span><span class="ace_cjk" style="width:NaNpx">况</span>,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// 1. <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">运</span><span class="ace_cjk" style="width:NaNpx">行</span><span class="ace_cjk" style="width:NaNpx">阶</span><span class="ace_cjk" style="width:NaNpx">段</span><span class="ace_cjk" style="width:NaNpx">动</span><span class="ace_cjk" style="width:NaNpx">态</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span>, <span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span><span class="ace_cjk" style="width:NaNpx">列</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">保</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">在</span> ht</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// 2. <span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">组</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span><span class="ace_cjk" style="width:NaNpx">保</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">在</span> ht</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">ht</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">nNumUsed</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">ht</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">arData</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">end</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">ht</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">nNumUsed</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">逆</span><span class="ace_cjk" style="width:NaNpx">序</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span><span class="ace_cjk" style="width:NaNpx">寻</span><span class="ace_cjk" style="width:NaNpx">找</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span> gc <span class="ace_cjk" style="width:NaNpx">信</span><span class="ace_cjk" style="width:NaNpx">息</span><span class="ace_cjk" style="width:NaNpx">的</span> Bucket</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_constant ace_numeric">1</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">end</span><span class="ace_keyword ace_operator">--</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">end</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">是</span>INDIRECT<span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">型</span>, <span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">实</span><span class="ace_cjk" style="width:NaNpx">际</span> zv</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_INDIRECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_INDIRECT_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">break</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// HashTable <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span><span class="ace_cjk" style="width:NaNpx">均</span><span class="ace_cjk" style="width:NaNpx">无</span> gc <span class="ace_cjk" style="width:NaNpx">信</span><span class="ace_cjk" style="width:NaNpx">息</span><span class="ace_cjk" style="width:NaNpx">直</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">返</span><span class="ace_cjk" style="width:NaNpx">回</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">正</span><span class="ace_cjk" style="width:NaNpx">序</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span> gc <span class="ace_cjk" style="width:NaNpx">信</span><span class="ace_cjk" style="width:NaNpx">息</span><span class="ace_cjk" style="width:NaNpx">的</span> Bucket, <span class="ace_cjk" style="width:NaNpx">减</span>1<span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span>, <span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">自</span><span class="ace_cjk" style="width:NaNpx">身</span>(<span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">包</span><span class="ace_cjk" style="width:NaNpx">括</span>end <span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">向</span><span class="ace_cjk" style="width:NaNpx">的</span> Bucket)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">p</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">是</span>INDIRECT<span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">型</span>, <span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">实</span><span class="ace_cjk" style="width:NaNpx">际</span> zv</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_INDIRECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_INDIRECT_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">--</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_mark_grey</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">p</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">此</span><span class="ace_cjk" style="width:NaNpx">时</span> p == end</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">原</span><span class="ace_cjk" style="width:NaNpx">地</span><span class="ace_cjk" style="width:NaNpx">减</span>1<span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">尾</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">处</span><span class="ace_cjk" style="width:NaNpx">理</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span> gc <span class="ace_cjk" style="width:NaNpx">信</span><span class="ace_cjk" style="width:NaNpx">息</span><span class="ace_cjk" style="width:NaNpx">的</span> Bucket</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">p</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_INDIRECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_INDIRECT_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">--</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">goto</span> <span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// GC <span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">阶</span><span class="ace_cjk" style="width:NaNpx">段</span>: <span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">static</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_mark_roots</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_root_buffer</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// GC_G(roots)<span class="ace_cjk" style="width:NaNpx">保</span><span class="ace_cjk" style="width:NaNpx">留</span>, <span class="ace_cjk" style="width:NaNpx">从</span>next<span class="ace_cjk" style="width:NaNpx">开</span><span class="ace_cjk" style="width:NaNpx">始</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span>GC_G(roots)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REF_GET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">GC_PURPLE</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_mark_grey</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">/*</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * After all possible roots are traversed and marked,</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * gc_scan_roots will be called, and each root will be called with</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * gc_scan(root-&gt;ref)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">static</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_scan</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_refcounted</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_identifier">HashTable</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ht</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">Bucket</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">p</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">end</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">zval</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zv</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">/*</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * If the node is marked as grey and the refcount &gt; 0</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> *    gc_scan_black will be called on that node to scan it's subgraph.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * otherwise (refcount == 0), it marks the node white.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// gc <span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">阶</span><span class="ace_cjk" style="width:NaNpx">段</span><span class="ace_cjk" style="width:NaNpx">把</span> ref <span class="ace_cjk" style="width:NaNpx">全</span><span class="ace_cjk" style="width:NaNpx">部</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span> grey</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REF_GET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">GC_GREY</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">&gt;</span> <span class="ace_constant ace_numeric">0</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">大</span><span class="ace_cjk" style="width:NaNpx">于</span>0, <span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">明</span><span class="ace_cjk" style="width:NaNpx">该</span> ref <span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span> black <span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">加</span>1<span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_scan_black</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">大</span><span class="ace_cjk" style="width:NaNpx">于</span>0, <span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">明</span><span class="ace_cjk" style="width:NaNpx">该</span> ref <span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span> ,<span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">白</span><span class="ace_cjk" style="width:NaNpx">色</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REF_SET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">GC_WHITE</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_OBJECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_object_get_gc_t</span> <span class="ace_identifier">get_gc</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_object</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">obj</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_object</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ZEND_ASSERT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">objects_store</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">object_buckets</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_FLAGS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">&amp;</span> <span class="ace_identifier">IS_OBJ_FREE_CALLED</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>                 <span class="ace_identifier">IS_OBJ_VALID</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">objects_store</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">object_buckets</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handle</span><span class="ace_paren ace_rparen">])</span> <span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>                 <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">get_gc</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handlers</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">get_gc</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_storage ace_type">int</span> <span class="ace_identifier">n</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zval</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zv</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">end</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zval</span> <span class="ace_identifier">tmp</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ZVAL_OBJ</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">tmp</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ht</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">get_gc</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">tmp</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">zv</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">n</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">end</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">n</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">ht</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">n</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">--</span><span class="ace_identifier">end</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_scan</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">ht</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">goto</span> <span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_ARRAY</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">((</span><span class="ace_identifier">zend_array</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">symbol_table</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">符</span><span class="ace_cjk" style="width:NaNpx">号</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">定</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REF_SET_BLACK</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ht</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_array</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_REFERENCE</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED</span><span class="ace_paren ace_lparen">(((</span><span class="ace_identifier">zend_reference</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED</span><span class="ace_paren ace_lparen">(((</span><span class="ace_identifier">zend_reference</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">goto</span> <span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">ht</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">nNumUsed</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">ht</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">arData</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">end</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">ht</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">nNumUsed</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_constant ace_numeric">1</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">end</span><span class="ace_keyword ace_operator">--</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">end</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_INDIRECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_INDIRECT_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">break</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">p</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_INDIRECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_INDIRECT_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_scan</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">p</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">p</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_INDIRECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_INDIRECT_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">goto</span> <span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// GC <span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">二</span><span class="ace_cjk" style="width:NaNpx">阶</span><span class="ace_cjk" style="width:NaNpx">段</span>: <span class="ace_cjk" style="width:NaNpx">扫</span><span class="ace_cjk" style="width:NaNpx">描</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">static</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_scan_roots</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_root_buffer</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_scan</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">为</span> ref <span class="ace_cjk" style="width:NaNpx">申</span><span class="ace_cjk" style="width:NaNpx">请</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">块</span> gc_root_buffer, <span class="ace_cjk" style="width:NaNpx">插</span><span class="ace_cjk" style="width:NaNpx">入</span>GC_G(roots) <span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">头</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">static</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_add_garbage</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_refcounted</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_root_buffer</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">buf</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">unused</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">优</span><span class="ace_cjk" style="width:NaNpx">先</span><span class="ace_cjk" style="width:NaNpx">从</span><span class="ace_cjk" style="width:NaNpx">离</span><span class="ace_cjk" style="width:NaNpx">线</span><span class="ace_cjk" style="width:NaNpx">的</span> unused <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span> gc_root_buffer, <span class="ace_cjk" style="width:NaNpx">其</span><span class="ace_cjk" style="width:NaNpx">次</span><span class="ace_cjk" style="width:NaNpx">从</span> GC_G(buf) <span class="ace_cjk" style="width:NaNpx">空</span><span class="ace_cjk" style="width:NaNpx">闲</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">组</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">为</span> ref <span class="ace_cjk" style="width:NaNpx">设</span><span class="ace_cjk" style="width:NaNpx">置</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">属</span> gc_root_buffer <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">地</span><span class="ace_cjk" style="width:NaNpx">址</span>, <span class="ace_cjk" style="width:NaNpx">做</span><span class="ace_cjk" style="width:NaNpx">关</span><span class="ace_cjk" style="width:NaNpx">联</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">buf</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>      <span class="ace_comment">// GC_G(unused)<span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">空</span><span class="ace_cjk" style="width:NaNpx">闲</span> gc_root_buffer, <span class="ace_cjk" style="width:NaNpx">则</span><span class="ace_cjk" style="width:NaNpx">从</span> unused <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">注</span><span class="ace_cjk" style="width:NaNpx">意</span>, unused <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">通</span><span class="ace_cjk" style="width:NaNpx">过</span> prev <span class="ace_cjk" style="width:NaNpx">逆</span><span class="ace_cjk" style="width:NaNpx">向</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">空</span><span class="ace_cjk" style="width:NaNpx">闲</span> gc_root_buffer</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span><span class="ace_cjk" style="width:NaNpx">的</span> prev <span class="ace_cjk" style="width:NaNpx">节</span><span class="ace_cjk" style="width:NaNpx">点</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">向</span> NULL</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">unused</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">buf</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">prev</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#if</span> <span class="ace_constant ace_numeric">1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* optimization: color is already GC_BLACK (0) */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">buf</span> <span class="ace_keyword ace_operator">-</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">buf</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#else</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REF_SET_ADDRESS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">buf</span> <span class="ace_keyword ace_operator">-</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">buf</span><span class="ace_paren ace_rparen">))</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">first_unused</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">last_unused</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">从</span> GC_G(buf) <span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">buf</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">first_unused</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">first_unused</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#if</span> <span class="ace_constant ace_numeric">1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* optimization: color is already GC_BLACK (0) */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">buf</span> <span class="ace_keyword ace_operator">-</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">buf</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#else</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REF_SET_ADDRESS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">buf</span> <span class="ace_keyword ace_operator">-</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">buf</span><span class="ace_paren ace_rparen">))</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">空</span><span class="ace_cjk" style="width:NaNpx">闲</span> gc_root_buffer, <span class="ace_cjk" style="width:NaNpx">从</span><span class="ace_cjk" style="width:NaNpx">额</span><span class="ace_cjk" style="width:NaNpx">外</span><span class="ace_cjk" style="width:NaNpx">的</span> buffer <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* If we don't have free slots in the buffer, allocate a new one and</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_comment">     * set it's address above GC_ROOT_BUFFER_MAX_ENTRIES that have special</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_comment">     * meaning.</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_comment">     */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span> trick <span class="ace_cjk" style="width:NaNpx">是</span>, <span class="ace_cjk" style="width:NaNpx">将</span><span class="ace_cjk" style="width:NaNpx">从</span><span class="ace_cjk" style="width:NaNpx">额</span><span class="ace_cjk" style="width:NaNpx">外</span> buffer <span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">的</span> gc_root_buffer <span class="ace_cjk" style="width:NaNpx">关</span><span class="ace_cjk" style="width:NaNpx">联</span><span class="ace_cjk" style="width:NaNpx">的</span> ref <span class="ace_cjk" style="width:NaNpx">的</span> gc_info <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">设</span><span class="ace_cjk" style="width:NaNpx">置</span><span class="ace_cjk" style="width:NaNpx">成</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">大</span><span class="ace_cjk" style="width:NaNpx">于</span> GC_ROOT_BUFFER_MAX_ENTRIES(10001) <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">样</span><span class="ace_cjk" style="width:NaNpx">就</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">区</span><span class="ace_cjk" style="width:NaNpx">分</span> ref <span class="ace_cjk" style="width:NaNpx">关</span><span class="ace_cjk" style="width:NaNpx">联</span><span class="ace_cjk" style="width:NaNpx">的</span> gc_root_buffer <span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">位</span><span class="ace_cjk" style="width:NaNpx">置</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// additional_buffer <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">地</span><span class="ace_cjk" style="width:NaNpx">址</span><span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">用</span> -&gt;used <span class="ace_cjk" style="width:NaNpx">游</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">示</span><span class="ace_cjk" style="width:NaNpx">的</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">additional_buffer</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">||</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">additional_buffer</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">used</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">GC_NUM_ADDITIONAL_ENTRIES</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">如</span><span class="ace_cjk" style="width:NaNpx">果</span>additional_buffer==NULL <span class="ace_cjk" style="width:NaNpx">或</span><span class="ace_cjk" style="width:NaNpx">者</span> <span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">前</span>additional_buffer<span class="ace_cjk" style="width:NaNpx">空</span><span class="ace_cjk" style="width:NaNpx">间</span><span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">经</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">光</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">则</span><span class="ace_cjk" style="width:NaNpx">额</span><span class="ace_cjk" style="width:NaNpx">外</span><span class="ace_cjk" style="width:NaNpx">申</span><span class="ace_cjk" style="width:NaNpx">请</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">块</span><span class="ace_cjk" style="width:NaNpx">新</span><span class="ace_cjk" style="width:NaNpx">的</span>additional_buffer, <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">的</span>additional_buffer<span class="ace_cjk" style="width:NaNpx">中</span>, new_buffer-&gt;next = GC_G(additional_buffer);</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">以</span>additional_buffer<span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">限</span><span class="ace_cjk" style="width:NaNpx">制</span><span class="ace_cjk" style="width:NaNpx">长</span><span class="ace_cjk" style="width:NaNpx">度</span>, <span class="ace_cjk" style="width:NaNpx">自</span><span class="ace_cjk" style="width:NaNpx">动</span><span class="ace_cjk" style="width:NaNpx">扩</span><span class="ace_cjk" style="width:NaNpx">容</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span>(<span class="ace_cjk" style="width:NaNpx">每</span><span class="ace_cjk" style="width:NaNpx">次</span><span class="ace_cjk" style="width:NaNpx">扩</span><span class="ace_cjk" style="width:NaNpx">容</span>4k<span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">存</span>),  <span class="ace_cjk" style="width:NaNpx">使</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">游</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">使</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">量</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_additional_buffer</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">new_buffer</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">emalloc</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">sizeof</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_additional_buffer</span><span class="ace_paren ace_rparen">))</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">new_buffer</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">used</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">new_buffer</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">additional_buffer</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">additional_buffer</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">new_buffer</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">总</span><span class="ace_cjk" style="width:NaNpx">挂</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">新</span><span class="ace_cjk" style="width:NaNpx">申</span><span class="ace_cjk" style="width:NaNpx">请</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">面</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">buf</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">additional_buffer</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">buf</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">additional_buffer</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">used</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#if</span> <span class="ace_constant ace_numeric">1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* optimization: color is already GC_BLACK (0) */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_ROOT_BUFFER_MAX_ENTRIES</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">additional_buffer</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">used</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#else</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REF_SET_ADDRESS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">GC_ROOT_BUFFER_MAX_ENTRIES</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">additional_buffer</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">used</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">additional_buffer</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">used</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// ?? <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">什</span><span class="ace_cjk" style="width:NaNpx">么</span><span class="ace_cjk" style="width:NaNpx">判</span><span class="ace_cjk" style="width:NaNpx">断</span> buf <span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">否</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">空</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">buf</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">使</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">新</span><span class="ace_cjk" style="width:NaNpx">申</span><span class="ace_cjk" style="width:NaNpx">请</span><span class="ace_cjk" style="width:NaNpx">的</span> gc_root_buffer <span class="ace_cjk" style="width:NaNpx">赋</span><span class="ace_cjk" style="width:NaNpx">值</span> ref, <span class="ace_cjk" style="width:NaNpx">插</span><span class="ace_cjk" style="width:NaNpx">入</span> GC_G(roots) <span class="ace_cjk" style="width:NaNpx">双</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">头</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">buf</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">buf</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">buf</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">buf</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">buf</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">下</span><span class="ace_cjk" style="width:NaNpx">注</span><span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">中</span> <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">的</span> <span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span>, e.g. zend_refcounted, zval..., <span class="ace_cjk" style="width:NaNpx">特</span><span class="ace_cjk" style="width:NaNpx">殊</span><span class="ace_cjk" style="width:NaNpx">情</span><span class="ace_cjk" style="width:NaNpx">况</span><span class="ace_cjk" style="width:NaNpx">指</span> php <span class="ace_cjk" style="width:NaNpx">代</span><span class="ace_cjk" style="width:NaNpx">码</span><span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">返</span><span class="ace_cjk" style="width:NaNpx">回</span><span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">理</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">经</span><span class="ace_cjk" style="width:NaNpx">初</span><span class="ace_cjk" style="width:NaNpx">始</span><span class="ace_cjk" style="width:NaNpx">化</span><span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">的</span> zval <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">量</span>(!= IS_UNDEF)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">非</span> refcounted <span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">型</span> zval <span class="ace_cjk" style="width:NaNpx">直</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">加</span>1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// refcounted <span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">型</span> zval <span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">处</span><span class="ace_cjk" style="width:NaNpx">理</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span> REFCOUNTED <span class="ace_cjk" style="width:NaNpx">的</span> ref: zend_array, zend_object, <span class="ace_cjk" style="width:NaNpx">其</span><span class="ace_cjk" style="width:NaNpx">中</span>IS_REFERENCE<span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">型</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">判</span><span class="ace_cjk" style="width:NaNpx">断</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span> zval <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">型</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// flags: <span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span><span class="ace_cjk" style="width:NaNpx">中</span> <span class="ace_cjk" style="width:NaNpx">只</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span> <span class="ace_cjk" style="width:NaNpx">子</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span> <span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span> GC_HAS_DESTRUCTORS, <span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">终</span><span class="ace_cjk" style="width:NaNpx">返</span><span class="ace_cjk" style="width:NaNpx">回</span><span class="ace_cjk" style="width:NaNpx">值</span><span class="ace_cjk" style="width:NaNpx">便</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">static</span> <span class="ace_storage ace_type">int</span> <span class="ace_identifier">gc_collect_white</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_refcounted</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">uint32_t</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">flags</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">int</span> <span class="ace_identifier">count</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">HashTable</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ht</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">Bucket</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">p</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">end</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">zval</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zv</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">应</span><span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">防</span><span class="ace_cjk" style="width:NaNpx">止</span><span class="ace_cjk" style="width:NaNpx">重</span><span class="ace_cjk" style="width:NaNpx">入</span>, <span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">程</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">多</span><span class="ace_cjk" style="width:NaNpx">次</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span> ref <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">执</span><span class="ace_cjk" style="width:NaNpx">行</span> collect_white</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REF_GET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">GC_WHITE</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ht</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// ?? <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">先</span><span class="ace_cjk" style="width:NaNpx">设</span><span class="ace_cjk" style="width:NaNpx">置</span><span class="ace_cjk" style="width:NaNpx">成</span> black, <span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">了</span><span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">除</span><span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">信</span><span class="ace_cjk" style="width:NaNpx">息</span><span class="ace_cjk" style="width:NaNpx">防</span><span class="ace_cjk" style="width:NaNpx">止</span><span class="ace_cjk" style="width:NaNpx">重</span><span class="ace_cjk" style="width:NaNpx">入</span>, <span class="ace_cjk" style="width:NaNpx">同</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">使</span>gc_info == <span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">数</span>(addr), <span class="ace_cjk" style="width:NaNpx">简</span><span class="ace_cjk" style="width:NaNpx">化</span> gc_info <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">判</span><span class="ace_cjk" style="width:NaNpx">断</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REF_SET_BLACK</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">兼</span><span class="ace_cjk" style="width:NaNpx">容</span><span class="ace_cjk" style="width:NaNpx">旧</span><span class="ace_cjk" style="width:NaNpx">版</span><span class="ace_cjk" style="width:NaNpx">本</span> php <span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span>gc_collect_cycles();<span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">返</span><span class="ace_cjk" style="width:NaNpx">回</span><span class="ace_cjk" style="width:NaNpx">值</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// php5<span class="ace_cjk" style="width:NaNpx">无</span>IS_REFERENCE<span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">型</span> zval</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* don't count references for compatibility ??? */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">IS_REFERENCE</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">count</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_OBJECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_object_get_gc_t</span> <span class="ace_identifier">get_gc</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_object</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">obj</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_object</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ZEND_ASSERT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">objects_store</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">object_buckets</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_FLAGS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">&amp;</span> <span class="ace_identifier">IS_OBJ_FREE_CALLED</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>                 <span class="ace_identifier">IS_OBJ_VALID</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">objects_store</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">object_buckets</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handle</span><span class="ace_paren ace_rparen">])</span> <span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>                 <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">get_gc</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handlers</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">get_gc</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_storage ace_type">int</span> <span class="ace_identifier">n</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zval</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zv</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">end</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zval</span> <span class="ace_identifier">tmp</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">该</span> ref <span class="ace_cjk" style="width:NaNpx">无</span> gc_info <span class="ace_cjk" style="width:NaNpx">说</span><span class="ace_cjk" style="width:NaNpx">明</span><span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">前</span> ref <span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">在</span> <span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">中</span>, <span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">定</span><span class="ace_cjk" style="width:NaNpx">发</span><span class="ace_cjk" style="width:NaNpx">生</span><span class="ace_cjk" style="width:NaNpx">在</span> gc_collect_white <span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">中</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">前</span><span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">只</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">白</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span>, <span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">父</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">白</span><span class="ace_cjk" style="width:NaNpx">色</span>(<span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span>), <span class="ace_cjk" style="width:NaNpx">意</span><span class="ace_cjk" style="width:NaNpx">味</span><span class="ace_cjk" style="width:NaNpx">着</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">子</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">都</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">是</span> <span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">嵌</span><span class="ace_cjk" style="width:NaNpx">套</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">子</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span> <span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">在</span> <span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span>, <span class="ace_cjk" style="width:NaNpx">也</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">在</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">的</span> ref (<span class="ace_cjk" style="width:NaNpx">即</span>!GC_INFO(ref)) , <span class="ace_cjk" style="width:NaNpx">都</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">其</span><span class="ace_cjk" style="width:NaNpx">申</span><span class="ace_cjk" style="width:NaNpx">请</span> gc_root_buffer, <span class="ace_cjk" style="width:NaNpx">将</span> ref <span class="ace_cjk" style="width:NaNpx">插</span><span class="ace_cjk" style="width:NaNpx">入</span><span class="ace_cjk" style="width:NaNpx">到</span> GC_G(roots)<span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">头</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#if</span> <span class="ace_constant ace_numeric">1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* optimization: color is GC_BLACK (0) */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#else</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">GC_ADDRESS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_add_garbage</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">自</span><span class="ace_cjk" style="width:NaNpx">定</span><span class="ace_cjk" style="width:NaNpx">义</span><span class="ace_cjk" style="width:NaNpx">析</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">针</span>, <span class="ace_cjk" style="width:NaNpx">且</span> php <span class="ace_cjk" style="width:NaNpx">代</span><span class="ace_cjk" style="width:NaNpx">码</span><span class="ace_cjk" style="width:NaNpx">未</span><span class="ace_cjk" style="width:NaNpx">声</span><span class="ace_cjk" style="width:NaNpx">明</span><span class="ace_cjk" style="width:NaNpx">析</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">析</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">则</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">有</span> object dtor <span class="ace_cjk" style="width:NaNpx">需</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">执</span><span class="ace_cjk" style="width:NaNpx">行</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handlers</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">dtor_obj</span> <span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>        <span class="ace_paren ace_lparen">((</span><span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handlers</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">dtor_obj</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">zend_objects_destroy_object</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">||</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>         <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ce</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">destructor</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">)))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">flags</span> <span class="ace_keyword ace_operator">|=</span> <span class="ace_identifier">GC_HAS_DESTRUCTORS</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ZVAL_OBJ</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">tmp</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ht</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">get_gc</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">tmp</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">zv</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">n</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">end</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">n</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">ht</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">n</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span> <span class="ace_identifier">count</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">无</span><span class="ace_cjk" style="width:NaNpx">运</span><span class="ace_cjk" style="width:NaNpx">行</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">动</span><span class="ace_cjk" style="width:NaNpx">态</span><span class="ace_cjk" style="width:NaNpx">添</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">反</span><span class="ace_cjk" style="width:NaNpx">向</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span><span class="ace_cjk" style="width:NaNpx">寻</span><span class="ace_cjk" style="width:NaNpx">找</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span> REFCOUNTED <span class="ace_cjk" style="width:NaNpx">的</span> ref: end</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">统</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">经</span><span class="ace_cjk" style="width:NaNpx">初</span><span class="ace_cjk" style="width:NaNpx">始</span><span class="ace_cjk" style="width:NaNpx">化</span><span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">的</span> zval <span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">量</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">--</span><span class="ace_identifier">end</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* count non-refcounted for compatibility ??? */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">没</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">型</span><span class="ace_cjk" style="width:NaNpx">的</span> zval <span class="ace_cjk" style="width:NaNpx">做</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">上</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">兼</span><span class="ace_cjk" style="width:NaNpx">容</span><span class="ace_cjk" style="width:NaNpx">处</span><span class="ace_cjk" style="width:NaNpx">理</span>(for php5.x)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">IS_UNDEF</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">count</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span> <span class="ace_identifier">count</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">正</span><span class="ace_cjk" style="width:NaNpx">向</span><span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span><span class="ace_cjk" style="width:NaNpx">到</span>end(<span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span> REFCOUNTED <span class="ace_cjk" style="width:NaNpx">的</span> ref), <span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">包</span><span class="ace_cjk" style="width:NaNpx">括</span> end</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span> <span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span> REFCOUNTED <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span> collect</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// ?? <span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">何</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">先</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">count</span> <span class="ace_keyword ace_operator">+=</span> <span class="ace_identifier">gc_collect_white</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">flags</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* count non-refcounted for compatibility ??? */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">IS_UNDEF</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">count</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">ht</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">尾</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">处</span><span class="ace_cjk" style="width:NaNpx">理</span> end (<span class="ace_cjk" style="width:NaNpx">非</span><span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span>, <span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">后</span><span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">个</span> refcounted <span class="ace_cjk" style="width:NaNpx">的</span> zval)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// ?? <span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">何</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">先</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">goto</span> <span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span> <span class="ace_identifier">count</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_ARRAY</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#if</span> <span class="ace_constant ace_numeric">1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* optimization: color is GC_BLACK (0) */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#else</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">GC_ADDRESS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">同</span> IS_OBJECT~</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_add_garbage</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ht</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_array</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_REFERENCE</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED</span><span class="ace_paren ace_lparen">(((</span><span class="ace_identifier">zend_reference</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED</span><span class="ace_paren ace_lparen">(((</span><span class="ace_identifier">zend_reference</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">goto</span> <span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span> <span class="ace_identifier">count</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span> <span class="ace_identifier">count</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">ht</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">nNumUsed</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span> <span class="ace_identifier">count</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">ht</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">arData</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">end</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">ht</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">nNumUsed</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_constant ace_numeric">1</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">end</span><span class="ace_keyword ace_operator">--</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">end</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_INDIRECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_INDIRECT_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">break</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* count non-refcounted for compatibility ??? */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">IS_UNDEF</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">count</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span> <span class="ace_identifier">count</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">p</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_INDIRECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_INDIRECT_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">count</span> <span class="ace_keyword ace_operator">+=</span> <span class="ace_identifier">gc_collect_white</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">flags</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* count non-refcounted for compatibility ??? */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">IS_UNDEF</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">count</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">p</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">p</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_INDIRECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_INDIRECT_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">goto</span> <span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">return</span> <span class="ace_identifier">count</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// GC <span class="ace_cjk" style="width:NaNpx">第</span><span class="ace_cjk" style="width:NaNpx">三</span><span class="ace_cjk" style="width:NaNpx">阶</span><span class="ace_cjk" style="width:NaNpx">段</span>: <span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">理</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">将</span><span class="ace_cjk" style="width:NaNpx">黑</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">从</span> GC_G(roots) <span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span>, <span class="ace_cjk" style="width:NaNpx">余</span><span class="ace_cjk" style="width:NaNpx">下</span><span class="ace_cjk" style="width:NaNpx">白</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">转</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">到</span> GC_G(to_free)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">static</span> <span class="ace_storage ace_type">int</span> <span class="ace_identifier">gc_collect_roots</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">uint32_t</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">flags</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">int</span> <span class="ace_identifier">count</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">gc_root_buffer</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">把</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">黑</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">的</span> possible gc <span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">从</span> GC_G(roots) <span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">/* remove non-garbage from the list */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_root_buffer</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REF_GET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">GC_BLACK</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">据</span><span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">否</span><span class="ace_cjk" style="width:NaNpx">超</span><span class="ace_cjk" style="width:NaNpx">过</span> GC_G(buf)<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">容</span><span class="ace_cjk" style="width:NaNpx">量</span><span class="ace_cjk" style="width:NaNpx">区</span><span class="ace_cjk" style="width:NaNpx">分</span><span class="ace_cjk" style="width:NaNpx">从</span> <span class="ace_cjk" style="width:NaNpx">哪</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_ADDRESS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">))</span> <span class="ace_keyword ace_operator">&lt;</span> <span class="ace_identifier">GC_ROOT_BUFFER_MAX_ENTRIES</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_remove_from_roots</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_remove_from_additional_roots</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">除</span> gc <span class="ace_cjk" style="width:NaNpx">信</span><span class="ace_cjk" style="width:NaNpx">息</span>: <span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">数</span>+<span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span>, <span class="ace_cjk" style="width:NaNpx">即</span><span class="ace_cjk" style="width:NaNpx">偏</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">数</span>=0, <span class="ace_cjk" style="width:NaNpx">颜</span><span class="ace_cjk" style="width:NaNpx">色</span>= black</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span> <span class="ace_comment">/* reset GC_ADDRESS() and keep GC_BLACK */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// ?? <span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">除</span><span class="ace_cjk" style="width:NaNpx">之</span><span class="ace_cjk" style="width:NaNpx">后</span>, GC_G(roots)  <span class="ace_cjk" style="width:NaNpx">应</span><span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">只</span><span class="ace_cjk" style="width:NaNpx">剩</span><span class="ace_cjk" style="width:NaNpx">下</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">为</span> white <span class="ace_cjk" style="width:NaNpx">的</span> gc_root_buf </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">统</span><span class="ace_cjk" style="width:NaNpx">计</span> <span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span> <span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">初</span><span class="ace_cjk" style="width:NaNpx">始</span><span class="ace_cjk" style="width:NaNpx">化</span> zval <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">量</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// ?? <span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">加</span> <span class="ace_cjk" style="width:NaNpx">嵌</span><span class="ace_cjk" style="width:NaNpx">套</span><span class="ace_cjk" style="width:NaNpx">子</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span> <span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">成</span> black, <span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span> GC_G(roots) <span class="ace_cjk" style="width:NaNpx">跟</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// ?? <span class="ace_cjk" style="width:NaNpx">其</span><span class="ace_cjk" style="width:NaNpx">中</span> refcounted <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">加</span>1 <span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REF_GET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">GC_WHITE</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">count</span> <span class="ace_keyword ace_operator">+=</span> <span class="ace_identifier">gc_collect_white</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">flags</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">/* relink remaining roots into list to free */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// GC_G(roots) <span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">转</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">到</span>GC_G(to_free)<span class="ace_cjk" style="width:NaNpx">并</span><span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">空</span>GC_G(roots)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// GC_G(to_free) <span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">空</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* move roots into list to free */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">prev</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">prev</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// GC_G(to_free) <span class="ace_cjk" style="width:NaNpx">不</span> <span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">空</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">双</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">连</span><span class="ace_cjk" style="width:NaNpx">接</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* add roots into list to free */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">prev</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">prev</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">prev</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">prev</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">空</span>GC_G(roots)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">return</span> <span class="ace_identifier">count</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">将</span> <span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">图</span> <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span> zend_refcounted <span class="ace_cjk" style="width:NaNpx">从</span> Roots buffer <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">析</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">导</span><span class="ace_cjk" style="width:NaNpx">致</span> ref <span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">增</span><span class="ace_cjk" style="width:NaNpx">加</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">处</span><span class="ace_cjk" style="width:NaNpx">理</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">析</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">部</span><span class="ace_cjk" style="width:NaNpx">捕</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">据</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// root: <span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">前</span> gc_root_buffer <span class="ace_cjk" style="width:NaNpx">根</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span>, <span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">程</span><span class="ace_cjk" style="width:NaNpx">为</span> NULL</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">static</span> <span class="ace_storage ace_type">void</span> <span class="ace_identifier">gc_remove_nested_data_from_buffer</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_refcounted</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">gc_root_buffer</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">root</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">HashTable</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ht</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">Bucket</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">p</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">end</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">zval</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zv</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">在</span> buffer <span class="ace_cjk" style="width:NaNpx">中</span> </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">root</span> <span class="ace_keyword ace_operator">||</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>        <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_ADDRESS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">))</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_constant ace_numeric">0</span> <span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>         <span class="ace_identifier">GC_REF_GET_COLOR</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">GC_BLACK</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_TRACE_REF</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_string ace_start">"</span><span class="ace_string">removing from buffer</span><span class="ace_string ace_end">"</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">root</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// refcount <span class="ace_cjk" style="width:NaNpx">增</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">后</span>, ref <span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">重</span><span class="ace_cjk" style="width:NaNpx">新</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span> Roots buffer</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_ADDRESS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">root</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">))</span> <span class="ace_keyword ace_operator">&lt;</span> <span class="ace_identifier">GC_ROOT_BUFFER_MAX_ENTRIES</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_remove_from_roots</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">root</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_remove_from_additional_roots</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">root</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">除</span> gc <span class="ace_cjk" style="width:NaNpx">信</span><span class="ace_cjk" style="width:NaNpx">息</span>(color+addr)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_INFO</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">root</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">程</span> <span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span><span class="ace_cjk" style="width:NaNpx">判</span><span class="ace_cjk" style="width:NaNpx">断</span>, <span class="ace_cjk" style="width:NaNpx">防</span><span class="ace_cjk" style="width:NaNpx">重</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REMOVE_FROM_BUFFER</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_OBJECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_object_get_gc_t</span> <span class="ace_identifier">get_gc</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_object</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">obj</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_object</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ZEND_ASSERT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">objects_store</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">object_buckets</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_FLAGS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">&amp;</span> <span class="ace_identifier">IS_OBJ_FREE_CALLED</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>                 <span class="ace_identifier">IS_OBJ_VALID</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">objects_store</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">object_buckets</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handle</span><span class="ace_paren ace_rparen">])</span> <span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>                     <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">get_gc</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handlers</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">get_gc</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_storage ace_type">int</span> <span class="ace_identifier">n</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zval</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zv</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">end</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zval</span> <span class="ace_identifier">tmp</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ZVAL_OBJ</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">tmp</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ht</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">get_gc</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">tmp</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">zv</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">n</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">end</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">n</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">ht</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">n</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">--</span><span class="ace_identifier">end</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// ~</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_remove_nested_data_from_buffer</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">ht</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">goto</span> <span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_ARRAY</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ht</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_array</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_REFERENCE</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED</span><span class="ace_paren ace_lparen">(((</span><span class="ace_identifier">zend_reference</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED</span><span class="ace_paren ace_lparen">(((</span><span class="ace_identifier">zend_reference</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">goto</span> <span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_identifier">ht</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">nNumUsed</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">ht</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">arData</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">end</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">ht</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">nNumUsed</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_constant ace_numeric">1</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">end</span><span class="ace_keyword ace_operator">--</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">end</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_INDIRECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_INDIRECT_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">break</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">end</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">p</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_INDIRECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_INDIRECT_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_REFCOUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// ~</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_remove_nested_data_from_buffer</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">p</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">p</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">val</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_TYPE_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_INDIRECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zv</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_INDIRECT_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_COUNTED_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zv</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">goto</span> <span class="ace_identifier">tail_call</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// gc <span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">终</span><span class="ace_cjk" style="width:NaNpx">暴</span><span class="ace_cjk" style="width:NaNpx">露</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">口</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_storage ace_type">int</span> <span class="ace_identifier">zend_gc_collect_cycles</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">最</span><span class="ace_cjk" style="width:NaNpx">终</span><span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">int</span> <span class="ace_identifier">count</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>  <span class="ace_comment">// Roots buffer <span class="ace_cjk" style="width:NaNpx">非</span><span class="ace_cjk" style="width:NaNpx">空</span>, </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">roots</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_root_buffer</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">current</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">orig_next_to_free</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_refcounted</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">p</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">本</span><span class="ace_cjk" style="width:NaNpx">地</span> free <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_root_buffer</span> <span class="ace_identifier">to_free</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">uint32_t</span> <span class="ace_identifier">gc_flags</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_additional_buffer</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">additional_buffer_snapshot</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#if</span> <span class="ace_identifier">ZEND_GC_DEBUG</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_bool</span> <span class="ace_identifier">orig_gc_full</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">防</span><span class="ace_cjk" style="width:NaNpx">止</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">前</span><span class="ace_cjk" style="width:NaNpx">两</span><span class="ace_cjk" style="width:NaNpx">个</span><span class="ace_cjk" style="width:NaNpx">阶</span><span class="ace_cjk" style="width:NaNpx">段</span>mark+scan<span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">再</span><span class="ace_cjk" style="width:NaNpx">次</span><span class="ace_cjk" style="width:NaNpx">执</span><span class="ace_cjk" style="width:NaNpx">行</span> gc</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_active</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_TRACE</span><span class="ace_paren ace_lparen">(</span><span class="ace_string ace_start">"</span><span class="ace_string">Collecting cycles</span><span class="ace_string ace_end">"</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_runs</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_active</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">1</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">下</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">具</span><span class="ace_cjk" style="width:NaNpx">体</span>GC<span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">程</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_TRACE</span><span class="ace_paren ace_lparen">(</span><span class="ace_string ace_start">"</span><span class="ace_string">Marking roots</span><span class="ace_string ace_end">"</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// 1. <span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">灰</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">并</span>+1 refcount</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_mark_roots</span><span class="ace_paren ace_lparen">(</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_TRACE</span><span class="ace_paren ace_lparen">(</span><span class="ace_string ace_start">"</span><span class="ace_string">Scanning roots</span><span class="ace_string ace_end">"</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// 2. <span class="ace_cjk" style="width:NaNpx">扫</span><span class="ace_cjk" style="width:NaNpx">描</span><span class="ace_cjk" style="width:NaNpx">判</span><span class="ace_cjk" style="width:NaNpx">断</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">否</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span>, root<span class="ace_cjk" style="width:NaNpx">的</span>refcount=0, <span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">白</span><span class="ace_cjk" style="width:NaNpx">色</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span>, &gt;0, <span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span><span class="ace_cjk" style="width:NaNpx">非</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span><span class="ace_cjk" style="width:NaNpx">并</span> -1 refcount</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_scan_roots</span><span class="ace_paren ace_lparen">(</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#if</span> <span class="ace_identifier">ZEND_GC_DEBUG</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">orig_gc_full</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_full</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_full</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// 3. <span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">理</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_TRACE</span><span class="ace_paren ace_lparen">(</span><span class="ace_string ace_start">"</span><span class="ace_string">Collecting roots</span><span class="ace_string ace_end">"</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// ?</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">additional_buffer_snapshot</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">additional_buffer</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">count</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">gc_collect_roots</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">gc_flags</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#if</span> <span class="ace_identifier">ZEND_GC_DEBUG</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_full</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">orig_gc_full</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// !!! <span class="ace_cjk" style="width:NaNpx">注</span><span class="ace_cjk" style="width:NaNpx">意</span><span class="ace_cjk" style="width:NaNpx">此</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">关</span><span class="ace_cjk" style="width:NaNpx">闭</span> active, <span class="ace_cjk" style="width:NaNpx">意</span><span class="ace_cjk" style="width:NaNpx">味</span><span class="ace_cjk" style="width:NaNpx">着</span> zend_gc_collect_cycles <span class="ace_cjk" style="width:NaNpx">未</span><span class="ace_cjk" style="width:NaNpx">返</span><span class="ace_cjk" style="width:NaNpx">回</span><span class="ace_cjk" style="width:NaNpx">前</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">比</span><span class="ace_cjk" style="width:NaNpx">如</span> gc <span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">程</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span>dtor <span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">程</span><span class="ace_cjk" style="width:NaNpx">中</span>, <span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">再</span><span class="ace_cjk" style="width:NaNpx">次</span><span class="ace_cjk" style="width:NaNpx">执</span><span class="ace_cjk" style="width:NaNpx">行</span> gc</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">/*</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">&lt;?php</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// gc.php</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">function cycle() { $t = new T; $t-&gt;t = $t; }</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">function cycle1() { $a = []; $a["a"] = &amp;$a; }</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">class T {</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_comment">    public function __destruct()</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_comment">    {</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_comment">    cycle1();</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_comment">    echo "dtor\n";</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_comment">    var_dump(gc_collect_cycles());</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_comment">    }</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">cycle();</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">var_dump(gc_collect_cycles());</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">fread(STDIN, 1024);</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">$ php gc.php</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">Collecting cycles</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">Marking roots</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">Scanning roots</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">Collecting roots</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">Calling destructors</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">dtor</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">Collecting cycles</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">Marking roots</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">Scanning roots</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">Collecting roots</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">Destroying zvals</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">Collection finished</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">int(1)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">Destroying zvals</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">Collection finished</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">int(1)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">*/</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_active</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// to_free <span class="ace_cjk" style="width:NaNpx">待</span><span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">空</span>, nothing to free....</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* nothing to free */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_TRACE</span><span class="ace_paren ace_lparen">(</span><span class="ace_string ace_start">"</span><span class="ace_string">Nothing to free</span><span class="ace_string ace_end">"</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">把</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">从</span>GC_G<span class="ace_cjk" style="width:NaNpx">转</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">本</span><span class="ace_cjk" style="width:NaNpx">地</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">原</span><span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">应</span><span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">：</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span><span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">程</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">再</span><span class="ace_cjk" style="width:NaNpx">次</span><span class="ace_cjk" style="width:NaNpx">触</span><span class="ace_cjk" style="width:NaNpx">发</span>GC~</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* Copy global to_free list into local list */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">to_free</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">to_free</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">prev</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">to_free</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">to_free</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">to_free</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">prev</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">to_free</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* Free global list */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">备</span><span class="ace_cjk" style="width:NaNpx">份</span> next_to_free, <span class="ace_cjk" style="width:NaNpx">结</span><span class="ace_cjk" style="width:NaNpx">束</span><span class="ace_cjk" style="width:NaNpx">时</span><span class="ace_cjk" style="width:NaNpx">恢</span><span class="ace_cjk" style="width:NaNpx">复</span>, <span class="ace_cjk" style="width:NaNpx">同</span><span class="ace_cjk" style="width:NaNpx">样</span><span class="ace_cjk" style="width:NaNpx">也</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">应</span><span class="ace_cjk" style="width:NaNpx">对</span> <span class="ace_cjk" style="width:NaNpx">嵌</span><span class="ace_cjk" style="width:NaNpx">套</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span> gc <span class="ace_cjk" style="width:NaNpx">发</span><span class="ace_cjk" style="width:NaNpx">生</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">orig_next_to_free</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">next_to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">同</span><span class="ace_cjk" style="width:NaNpx">理</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#if</span> <span class="ace_identifier">ZEND_GC_DEBUG</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">orig_gc_full</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_full</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_full</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// flags <span class="ace_cjk" style="width:NaNpx">来</span><span class="ace_cjk" style="width:NaNpx">自</span> gc_collect_roots(&amp;gc_flags); </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">即</span><span class="ace_cjk" style="width:NaNpx">收</span><span class="ace_cjk" style="width:NaNpx">集</span><span class="ace_cjk" style="width:NaNpx">阶</span><span class="ace_cjk" style="width:NaNpx">段</span><span class="ace_cjk" style="width:NaNpx">发</span><span class="ace_cjk" style="width:NaNpx">现</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">垃</span><span class="ace_cjk" style="width:NaNpx">圾</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">含</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">自</span><span class="ace_cjk" style="width:NaNpx">定</span><span class="ace_cjk" style="width:NaNpx">义</span><span class="ace_cjk" style="width:NaNpx">析</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">指</span><span class="ace_cjk" style="width:NaNpx">针</span>(IS_OBJECT <span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">型</span> zval <span class="ace_cjk" style="width:NaNpx">有</span> dtor <span class="ace_cjk" style="width:NaNpx">需</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">执</span><span class="ace_cjk" style="width:NaNpx">行</span>), <span class="ace_cjk" style="width:NaNpx">且</span> php <span class="ace_cjk" style="width:NaNpx">代</span><span class="ace_cjk" style="width:NaNpx">码</span><span class="ace_cjk" style="width:NaNpx">未</span><span class="ace_cjk" style="width:NaNpx">声</span><span class="ace_cjk" style="width:NaNpx">明</span><span class="ace_cjk" style="width:NaNpx">析</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">析</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_flags</span> <span class="ace_keyword ace_operator">&amp;</span> <span class="ace_identifier">GC_HAS_DESTRUCTORS</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_TRACE</span><span class="ace_paren ace_lparen">(</span><span class="ace_string ace_start">"</span><span class="ace_string">Calling destructors</span><span class="ace_string ace_end">"</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span> <span class="ace_cjk" style="width:NaNpx">备</span><span class="ace_cjk" style="width:NaNpx">份</span> refcoucnt</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* Remember reference counters before calling destructors */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">to_free</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">refcount</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">遍</span><span class="ace_cjk" style="width:NaNpx">历</span>to_free<span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span> <span class="ace_cjk" style="width:NaNpx">执</span><span class="ace_cjk" style="width:NaNpx">行</span> <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">的</span> dtor_obj <span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* Call destructors */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">to_free</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// ?? <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span> <span class="ace_cjk" style="width:NaNpx">保</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">全</span><span class="ace_cjk" style="width:NaNpx">局</span><span class="ace_cjk" style="width:NaNpx">变</span><span class="ace_cjk" style="width:NaNpx">量</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">了</span>: dtor_obj <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">嵌</span><span class="ace_cjk" style="width:NaNpx">套</span> gc <span class="ace_cjk" style="width:NaNpx">或</span> gc_remove_nested_data_from_buffer</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">触</span><span class="ace_cjk" style="width:NaNpx">发</span> gc_remove_from_buffer <span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">跳</span><span class="ace_cjk" style="width:NaNpx">过</span> <span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">经</span><span class="ace_cjk" style="width:NaNpx">从</span> Roots buffer <span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span><span class="ace_cjk" style="width:NaNpx">的</span> gc_root_buffer</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">next_to_free</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">p</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_OBJECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_object</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">obj</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_object</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">p</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">IS_OBJ_VALID</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">objects_store</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">object_buckets</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handle</span><span class="ace_paren ace_rparen">])</span> <span class="ace_keyword ace_operator">&amp;&amp;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_operator">!</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_FLAGS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">&amp;</span> <span class="ace_identifier">IS_OBJ_DESTRUCTOR_CALLED</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_TRACE_REF</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">obj</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_string ace_start">"</span><span class="ace_string">calling destructor</span><span class="ace_string ace_end">"</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">注</span><span class="ace_cjk" style="width:NaNpx">意</span><span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span>, <span class="ace_cjk" style="width:NaNpx">防</span><span class="ace_cjk" style="width:NaNpx">止</span><span class="ace_cjk" style="width:NaNpx">重</span><span class="ace_cjk" style="width:NaNpx">复</span><span class="ace_cjk" style="width:NaNpx">执</span><span class="ace_cjk" style="width:NaNpx">行</span> dtor</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_FLAGS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">|=</span> <span class="ace_identifier">IS_OBJ_DESTRUCTOR_CALLED</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handlers</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">dtor_obj</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">先</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">再</span><span class="ace_cjk" style="width:NaNpx">减</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">原</span><span class="ace_cjk" style="width:NaNpx">因</span><span class="ace_cjk" style="width:NaNpx">是</span>, dtor_obj <span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">能</span><span class="ace_cjk" style="width:NaNpx">再</span><span class="ace_cjk" style="width:NaNpx">次</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span> gc, </span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// ?? <span class="ace_cjk" style="width:NaNpx">防</span><span class="ace_cjk" style="width:NaNpx">止</span><span class="ace_cjk" style="width:NaNpx">嵌</span><span class="ace_cjk" style="width:NaNpx">套</span><span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">部</span><span class="ace_cjk" style="width:NaNpx">的</span> gc <span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">程</span><span class="ace_cjk" style="width:NaNpx">把</span> ref <span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span>, <span class="ace_cjk" style="width:NaNpx">但</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">经</span><span class="ace_cjk" style="width:NaNpx">有</span> IS_OBJ_DESTRUCTOR_CALLED <span class="ace_cjk" style="width:NaNpx">标</span><span class="ace_cjk" style="width:NaNpx">记</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handlers</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">dtor_obj</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">--</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">next_to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* Remove values captured in destructors */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">to_free</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// ??  <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span> <span class="ace_cjk" style="width:NaNpx">保</span><span class="ace_cjk" style="width:NaNpx">存</span><span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">到</span><span class="ace_cjk" style="width:NaNpx">全</span><span class="ace_cjk" style="width:NaNpx">局</span><span class="ace_cjk" style="width:NaNpx">变</span><span class="ace_cjk" style="width:NaNpx">量</span><span class="ace_cjk" style="width:NaNpx">是</span><span class="ace_cjk" style="width:NaNpx">为</span><span class="ace_cjk" style="width:NaNpx">了</span>: dtor_obj <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">嵌</span><span class="ace_cjk" style="width:NaNpx">套</span> gc <span class="ace_cjk" style="width:NaNpx">或</span> gc_remove_nested_data_from_buffer</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">中</span><span class="ace_cjk" style="width:NaNpx">触</span><span class="ace_cjk" style="width:NaNpx">发</span> gc_remove_from_buffer <span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">跳</span><span class="ace_cjk" style="width:NaNpx">过</span> <span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">经</span><span class="ace_cjk" style="width:NaNpx">从</span> Roots buffer <span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span><span class="ace_cjk" style="width:NaNpx">的</span> gc_root_buffer</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">next_to_free</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span> dtor <span class="ace_cjk" style="width:NaNpx">执</span><span class="ace_cjk" style="width:NaNpx">行</span><span class="ace_cjk" style="width:NaNpx">完</span><span class="ace_cjk" style="width:NaNpx">成</span><span class="ace_cjk" style="width:NaNpx">之</span><span class="ace_cjk" style="width:NaNpx">后</span>, to_free <span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">计</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">比</span><span class="ace_cjk" style="width:NaNpx">之</span><span class="ace_cjk" style="width:NaNpx">前</span><span class="ace_cjk" style="width:NaNpx">备</span><span class="ace_cjk" style="width:NaNpx">份</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">值</span><span class="ace_cjk" style="width:NaNpx">高</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">说</span><span class="ace_cjk" style="width:NaNpx">明</span><span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">在</span><span class="ace_cjk" style="width:NaNpx">析</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">内</span> <span class="ace_cjk" style="width:NaNpx">又</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">重</span><span class="ace_cjk" style="width:NaNpx">新</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span> ~, e.g.  <span class="ace_cjk" style="width:NaNpx">析</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">使</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">闭</span><span class="ace_cjk" style="width:NaNpx">包</span> use($this)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">&gt;</span> <span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">refcount</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">部</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">使</span><span class="ace_cjk" style="width:NaNpx">用</span> GC_G(next_to_free)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">递</span><span class="ace_cjk" style="width:NaNpx">归</span><span class="ace_cjk" style="width:NaNpx">将</span> current <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">图</span><span class="ace_cjk" style="width:NaNpx">中</span> refcounted <span class="ace_cjk" style="width:NaNpx">从</span> Roots buffer <span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// ?? <span class="ace_cjk" style="width:NaNpx">嵌</span><span class="ace_cjk" style="width:NaNpx">套</span> gc <span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">起</span><span class="ace_cjk" style="width:NaNpx">的</span> Roots buffer <span class="ace_cjk" style="width:NaNpx">增</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">元</span><span class="ace_cjk" style="width:NaNpx">素</span> <span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">确</span><span class="ace_cjk" style="width:NaNpx">定</span><span class="ace_cjk" style="width:NaNpx">为</span> <span class="ace_cjk" style="width:NaNpx">循</span><span class="ace_cjk" style="width:NaNpx">环</span><span class="ace_cjk" style="width:NaNpx">引</span><span class="ace_cjk" style="width:NaNpx">用</span>, <span class="ace_cjk" style="width:NaNpx">可</span><span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">直</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">除</span>???</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_remove_nested_data_from_buffer</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">current</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">next_to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">于</span><span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">上</span>, <span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">上</span><span class="ace_cjk" style="width:NaNpx">调</span><span class="ace_cjk" style="width:NaNpx">用</span> dtor_obj <span class="ace_cjk" style="width:NaNpx">析</span><span class="ace_cjk" style="width:NaNpx">构</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span>, <span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">下</span> free_obj + free(p) <span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span> zend_object</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* Destroy zvals */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_TRACE</span><span class="ace_paren ace_lparen">(</span><span class="ace_string ace_start">"</span><span class="ace_string">Destroying zvals</span><span class="ace_string ace_end">"</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span> zval <span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">程</span><span class="ace_cjk" style="width:NaNpx">中</span>, <span class="ace_cjk" style="width:NaNpx">不</span><span class="ace_cjk" style="width:NaNpx">允</span><span class="ace_cjk" style="width:NaNpx">许</span><span class="ace_cjk" style="width:NaNpx">嵌</span><span class="ace_cjk" style="width:NaNpx">套</span><span class="ace_cjk" style="width:NaNpx">执</span><span class="ace_cjk" style="width:NaNpx">行</span> gc</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_active</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">1</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">to_free</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">next_to_free</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_TRACE_REF</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">p</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_string ace_start">"</span><span class="ace_string">destroying</span><span class="ace_string ace_end">"</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">p</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_OBJECT</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_object</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">obj</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_object</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">p</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// (!(((zend_uintptr_t)((executor_globals.objects_store).object_buckets[obj-&gt;handle])) &amp; (1&lt;&lt;0)))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">IS_OBJ_VALID</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">objects_store</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">object_buckets</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handle</span><span class="ace_paren ace_rparen">]))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>      <span class="ace_comment">//                                              ((zend_object*)((((zend_uintptr_t)(obj)) | (1&lt;&lt;0))))</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">objects_store</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">object_buckets</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handle</span><span class="ace_paren ace_rparen">]</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">SET_OBJ_INVALID</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">IS_NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">!</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_FLAGS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">&amp;</span> <span class="ace_identifier">IS_OBJ_FREE_CALLED</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_FLAGS</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">|=</span> <span class="ace_identifier">IS_OBJ_FREE_CALLED</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handlers</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">free_obj</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">++</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handlers</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">free_obj</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_REFCOUNT</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">--</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// ((executor_globals.objects_store).object_buckets[obj-&gt;handle]) = (zend_object*)((((zend_uintptr_t)((executor_globals.objects_store).free_list_head)) &lt;&lt; 1) | (1&lt;&lt;0));</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">SET_OBJ_BUCKET_NUMBER</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">objects_store</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">object_buckets</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handle</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">objects_store</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">free_list_head</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">EG</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">objects_store</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">free_list_head</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handle</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_refcounted</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_paren ace_lparen">(((</span><span class="ace_storage ace_type">char</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">-</span> <span class="ace_identifier">obj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">handlers</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">offset</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">p</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">IS_ARRAY</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_array</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">arr</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zend_array</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">p</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_TYPE</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">arr</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">IS_NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* GC may destroy arrays with rc&gt;1. This is valid and safe. */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">HT_ALLOW_COW_VIOLATION</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">arr</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_hash_destroy</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">arr</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">next_to_free</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">以</span><span class="ace_cjk" style="width:NaNpx">下</span> <span class="ace_cjk" style="width:NaNpx">两</span><span class="ace_cjk" style="width:NaNpx">部</span><span class="ace_cjk" style="width:NaNpx">分</span> <span class="ace_cjk" style="width:NaNpx">相</span><span class="ace_cjk" style="width:NaNpx">当</span><span class="ace_cjk" style="width:NaNpx">于</span><span class="ace_cjk" style="width:NaNpx">清</span><span class="ace_cjk" style="width:NaNpx">理</span> Roots buffer</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// 1. <span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span> <span class="ace_cjk" style="width:NaNpx">之</span><span class="ace_cjk" style="width:NaNpx">前</span> <span class="ace_cjk" style="width:NaNpx">在</span> roots <span class="ace_cjk" style="width:NaNpx">中</span> gc_root_buffer, <span class="ace_cjk" style="width:NaNpx">移</span><span class="ace_cjk" style="width:NaNpx">回</span> unused</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// 2. <span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span> <span class="ace_cjk" style="width:NaNpx">之</span><span class="ace_cjk" style="width:NaNpx">前</span> additional_buffer <span class="ace_cjk" style="width:NaNpx">的</span> gc_root_buffer (<span class="ace_cjk" style="width:NaNpx">直</span><span class="ace_cjk" style="width:NaNpx">接</span> free <span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span> additional_buffer)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_comment">/* Free objects */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">to_free</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">to_free</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">这</span><span class="ace_cjk" style="width:NaNpx">里</span><span class="ace_cjk" style="width:NaNpx">的</span> next <span class="ace_cjk" style="width:NaNpx">使</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">局</span><span class="ace_cjk" style="width:NaNpx">部</span><span class="ace_cjk" style="width:NaNpx">变</span><span class="ace_cjk" style="width:NaNpx">量</span><span class="ace_cjk" style="width:NaNpx">即</span><span class="ace_cjk" style="width:NaNpx">可</span>~</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">p</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ref</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">EXPECTED</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">&gt;=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">buf</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">&amp;&amp;</span> <span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">&lt;</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">buf</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">+</span> <span class="ace_identifier">GC_ROOT_BUFFER_MAX_ENTRIES</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">将</span> current <span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span> unused</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">prev</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">unused</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">unused</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">current</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">efree</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">p</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">释</span><span class="ace_cjk" style="width:NaNpx">放</span><span class="ace_cjk" style="width:NaNpx">所</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">额</span><span class="ace_cjk" style="width:NaNpx">外</span><span class="ace_cjk" style="width:NaNpx">申</span><span class="ace_cjk" style="width:NaNpx">请</span><span class="ace_cjk" style="width:NaNpx">的</span> buffer</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">while</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">additional_buffer</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">additional_buffer_snapshot</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">gc_additional_buffer</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">additional_buffer</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">efree</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">additional_buffer</span><span class="ace_paren ace_rparen">))</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">additional_buffer</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_TRACE</span><span class="ace_paren ace_lparen">(</span><span class="ace_string ace_start">"</span><span class="ace_string">Collection finished</span><span class="ace_string ace_end">"</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">collected</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">+=</span> <span class="ace_identifier">count</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">next_to_free</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">orig_next_to_free</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#if</span> <span class="ace_identifier">ZEND_GC_DEBUG</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_full</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">orig_gc_full</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#endif</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">GC_G</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">gc_active</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">return</span> <span class="ace_identifier">count</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">/*</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * Local variables:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * tab-width: 4</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * c-basic-offset: 4</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * indent-tabs-mode: t</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * End:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> *</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> * vim:noexpandtab:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"> */</span>
</div></div></div></div><div class="cell code-cell"><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// zend_object_handlers.c</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">该</span><span class="ace_cjk" style="width:NaNpx">方</span><span class="ace_cjk" style="width:NaNpx">法</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">两</span><span class="ace_cjk" style="width:NaNpx">种</span><span class="ace_cjk" style="width:NaNpx">返</span><span class="ace_cjk" style="width:NaNpx">回</span><span class="ace_cjk" style="width:NaNpx">方</span><span class="ace_cjk" style="width:NaNpx">式</span>:</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// 1. return HashTable != NULL <span class="ace_cjk" style="width:NaNpx">时</span>, table = NULL n = 0 <span class="ace_cjk" style="width:NaNpx">都</span><span class="ace_cjk" style="width:NaNpx">无</span><span class="ace_cjk" style="width:NaNpx">用</span>, <span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">量</span><span class="ace_cjk" style="width:NaNpx">要</span><span class="ace_cjk" style="width:NaNpx">通</span><span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span>ht<span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">量</span><span class="ace_cjk" style="width:NaNpx">宏</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">// 2. return HashTable == NULL <span class="ace_cjk" style="width:NaNpx">时</span>, <span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span><span class="ace_cjk" style="width:NaNpx">与</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">量</span><span class="ace_cjk" style="width:NaNpx">通</span><span class="ace_cjk" style="width:NaNpx">过</span> table <span class="ace_cjk" style="width:NaNpx">与</span> n<span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">ZEND_API</span> <span class="ace_identifier">HashTable</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zend_std_get_gc</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zval</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">object</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">zval</span> <span class="ace_keyword ace_operator">**</span><span class="ace_identifier">table</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_storage ace_type">int</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">n</span><span class="ace_paren ace_rparen">)</span> <span class="ace_comment">/* {{{ */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">Z_OBJ_HANDLER_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">object</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">get_properties</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_operator">!=</span> <span class="ace_identifier">zend_std_get_properties</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">通</span><span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">自</span><span class="ace_cjk" style="width:NaNpx">定</span><span class="ace_cjk" style="width:NaNpx">义</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">table</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">n</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span> <span class="ace_identifier">Z_OBJ_HANDLER_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">object</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">get_properties</span><span class="ace_paren ace_rparen">)</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">object</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">通</span><span class="ace_cjk" style="width:NaNpx">过</span>std<span class="ace_cjk" style="width:NaNpx">对</span><span class="ace_cjk" style="width:NaNpx">象</span><span class="ace_cjk" style="width:NaNpx">通</span><span class="ace_cjk" style="width:NaNpx">用</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span><span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zend_object</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">zobj</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">Z_OBJ_P</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">object</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">zobj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">properties</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">一</span><span class="ace_cjk" style="width:NaNpx">旦</span><span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">未</span><span class="ace_cjk" style="width:NaNpx">显</span><span class="ace_cjk" style="width:NaNpx">式</span><span class="ace_cjk" style="width:NaNpx">声</span><span class="ace_cjk" style="width:NaNpx">明</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">动</span><span class="ace_cjk" style="width:NaNpx">态</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span><span class="ace_cjk" style="width:NaNpx">直</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">通</span><span class="ace_cjk" style="width:NaNpx">过</span><span class="ace_cjk" style="width:NaNpx">动</span><span class="ace_cjk" style="width:NaNpx">态</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span>hashtable<span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_comment">// class<span class="ace_cjk" style="width:NaNpx">显</span><span class="ace_cjk" style="width:NaNpx">示</span><span class="ace_cjk" style="width:NaNpx">定</span><span class="ace_cjk" style="width:NaNpx">义</span><span class="ace_cjk" style="width:NaNpx">的</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span><span class="ace_cjk" style="width:NaNpx">也</span><span class="ace_cjk" style="width:NaNpx">会</span><span class="ace_cjk" style="width:NaNpx">被</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">入</span><span class="ace_cjk" style="width:NaNpx">该</span>hashtable<span class="ace_cjk" style="width:NaNpx">表</span>, indirect <span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">型</span>~</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_comment">// ht<span class="ace_cjk" style="width:NaNpx">的</span>value<span class="ace_cjk" style="width:NaNpx">类</span><span class="ace_cjk" style="width:NaNpx">型</span><span class="ace_cjk" style="width:NaNpx">为</span>zend_property_info</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>  <span class="ace_comment">/*</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_comment">  typedef struct _zend_property_info {</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">          uint32_t offset; // property offset for object properties or</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">                                property index for static properties</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">          uint32_t flags;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">          zend_string *name;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">          zend_string *doc_comment;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment">          zend_class_entry *ce;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_comment">  } zend_property_info;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_comment">  */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">table</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">n</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span> <span class="ace_identifier">zobj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">properties</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>      <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">无</span><span class="ace_cjk" style="width:NaNpx">动</span><span class="ace_cjk" style="width:NaNpx">态</span><span class="ace_cjk" style="width:NaNpx">添</span><span class="ace_cjk" style="width:NaNpx">加</span><span class="ace_cjk" style="width:NaNpx">属</span><span class="ace_cjk" style="width:NaNpx">性</span>, <span class="ace_cjk" style="width:NaNpx">直</span><span class="ace_cjk" style="width:NaNpx">接</span><span class="ace_cjk" style="width:NaNpx">从</span>properties_table<span class="ace_cjk" style="width:NaNpx">获</span><span class="ace_cjk" style="width:NaNpx">取</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">table</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">zobj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">properties_table</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">n</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">zobj</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">ce</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">default_properties_count</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div></div></div></div></div>
      <script></script>
    </body>
    </html>
  